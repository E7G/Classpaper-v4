# ClassPaper v4 (Rust 版)

## 简介
ClassPaper v4 是一款基于 Rust + alcro 的现代化桌面课程表/壁纸/告示牌应用，支持 Windows 系统。它将网页技术与系统托盘、壁纸、音频、穿透等深度集成，适合教室、教研室、个人学习等多场景使用。

---

## 主要功能
- **网页课表/壁纸**：支持本地 HTML 或远程 URL 作为动态壁纸，自动适应分辨率。
- **系统托盘菜单**：一键重载、重启、设置、穿透、退出等操作。
- **桌面穿透**：主窗口可置于桌面最底层，实现壁纸/透明效果。
- **配置热重载**：修改 `config.toml` 或设置界面后可即时生效，无需重启主程序。
- **多窗口支持**：主窗口、设置窗口等均可多开，全部随主程序优雅关闭。
- **音频提示**：支持定时播放提示音（如上课/下课铃声）。
- **壁纸管理**：支持壁纸文件夹扫描、自动切换。
- **告示牌/事件日历**：支持 HTML 告示内容、事件日历展示。
- **日志记录**：所有关键事件、错误输出到 `app.log`。

---

## 托盘菜单说明
| 菜单项             | 说明                                                         |
|--------------------|--------------------------------------------------------------|
| 重载网页           | 刷新主窗口内容，适合网页内容变更后手动刷新                   |
| 设置程序桌面穿透   | 将主窗口置于桌面最底层，实现壁纸/透明/穿透效果               |
| 重启网页显示程序   | 关闭并重建主窗口，应用最新配置（config.toml），并设置穿透     |
| 设置               | 打开设置窗口，支持配置热修改、壁纸管理、事件、告示牌等         |
| 重启程序           | 重启整个主程序进程，适合升级或彻底重载                        |
| 退出程序           | 优雅关闭所有窗口并退出，确保无残留进程                        |

**典型场景**：
- 课表/壁纸内容变更后，点击“重载网页”或“重启网页显示程序”即可生效。
- 需要切换壁纸、调整配置时，点击“设置”进入设置界面。
- 程序异常或升级后，点击“重启程序”彻底重载。

---

## 配置文件详细说明
- 配置文件为 `config.toml`，支持热重载。
- 推荐格式（区分大小写，兼容 Go 版）：

```toml
[Default]
URL = "./res/index.html"         # 主网页/壁纸页面路径（本地或远程）
BrowserPath = ""                 # 可选：自定义 Chrome/Edge 路径
```

- 字段说明：
    - `URL`：主窗口加载的网页路径，支持本地相对路径或 http(s) URL。
    - `BrowserPath`：可选，指定 Chrome/Edge 可执行文件路径，留空则自动查找。
- 兼容旧格式 `[default] url = ... browser_path = ...`，自动迁移为新格式。

---

## 运行环境与依赖
- **操作系统**：Windows 10/11（推荐 64 位）
- **Rust 工具链**：建议 1.60+，需支持 2021 edition
- **alcro**：本地打补丁版，自动管理 user-data-dir，支持严格关闭
- **Chrome/Edge**：需安装任一 Chromium 内核浏览器
- **其它依赖**：`tray-item`、`simplelog`、`ctrlc`、`serde`、`toml`、`percent-encoding` 等

---

## 目录结构说明
```
Classpaper-v4/
├── src/                # 主程序 Rust 源码
├── alcro-patched/      # 本地打补丁的 alcro 源码
├── res/                # 静态资源（html/css/js/audio/wallpaper）
├── config.toml         # 主配置文件
├── app.log             # 日志输出
├── README.md           # 本说明文档
└── ...
```

---

## 运行与构建
1. 安装 Rust 工具链（https://rustup.rs/）
2. `cargo build --release`
3. 运行 `target/release/classpaper.exe`
4. 托盘菜单管理主窗口、设置、重启、退出等

---

## 常见问题与排查
- **窗口无法关闭/残留进程**：所有窗口均用 `close_blocking` 严格关闭，若遇异常请检查日志 `app.log`。
- **配置不生效**：请确认 `config.toml` 格式正确，或通过“设置”界面修改。
- **壁纸/音频无法播放**：请检查 `res/wallpaper`、`res/audio` 目录下文件是否存在。
- **托盘图标不显示**：请确保 `IDI_ICON1` 资源已正确嵌入，或重启资源管理器。
- **Chrome/Edge 未检测到**：可在配置中手动指定 `BrowserPath`。
- **panic 或管道错误**：程序已自动 sleep 并优雅退出，若仍有问题请反馈日志。

---

## Rust/Go 迁移注意事项
- Rust 版所有窗口关闭、配置热重载、托盘菜单行为与 Go 版完全一致
- 配置文件格式兼容 Go 版，支持自动迁移
- Rust 版自动管理 Chrome user-data-dir，无需手动清理
- 关闭逻辑更安全，避免残留进程和 panic

---

## 贡献与开发建议
- 欢迎提交 issue、PR 或建议
- 主要开发入口为 `src/main.rs`，alcro 补丁位于 `alcro-patched/`
- 静态资源可直接修改 `res/` 目录
- 日志输出详见 `app.log`

---

## 联系方式/社区支持
- GitHub Issue
- 邮箱/QQ群（请在 issue 留言获取）

---

如有问题请提交 issue 或联系作者。