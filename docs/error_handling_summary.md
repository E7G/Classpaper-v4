# ClassPaper 错误处理增强功能总结

## 已实现的全局错误通知功能

### ✅ 新增错误弹窗通知场景

#### 1. 窗口创建错误
- **触发场景**：主窗口、设置窗口创建失败
- **错误信息**：包含浏览器未安装、路径错误、权限问题等详细原因
- **处理方式**：显示Windows原生弹窗，程序优雅退出

#### 2. 桌面穿透设置错误
- **触发场景**：桌面穿透设置失败
- **错误信息**：系统权限不足、桌面窗口被占用、版本兼容性问题
- **处理方式**：提示用户以管理员身份运行，查看日志文件

#### 3. 配置文件操作错误
- **触发场景**：
  - 读取config.toml失败
  - 保存配置到config.toml失败
  - 配置JSON解析失败
  - 配置序列化失败
- **错误信息**：文件权限、磁盘空间、路径错误等具体原因
- **处理方式**：提示用户检查文件权限，程序使用默认配置继续运行

#### 4. 系统托盘创建错误
- **触发场景**：系统托盘图标创建失败
- **错误信息**：系统资源不足、权限问题
- **处理方式**：程序继续运行，但无托盘功能

#### 5. 日志文件创建错误
- **触发场景**：无法创建或写入app.log文件
- **错误信息**：文件权限、磁盘空间不足
- **处理方式**：程序继续运行，日志输出到stderr

#### 6. 文件操作错误
- **触发场景**：
  - 写入文件失败（如自定义配置、用户数据等）
  - 壁纸目录扫描失败
- **错误信息**：权限不足、文件被占用、路径不存在
- **处理方式**：提示具体错误原因和解决建议

#### 7. 浏览器打开错误
- **触发场景**：点击链接无法打开默认浏览器
- **错误信息**：未安装浏览器、系统关联设置问题
- **处理方式**：提示用户检查浏览器设置或手动访问

#### 8. 信号处理错误
- **触发场景**：Ctrl+C信号处理程序设置失败
- **错误信息**：系统资源不足
- **处理方式**：程序继续运行，但可能无法优雅退出

#### 9. 日志系统初始化错误
- **触发场景**：日志系统初始化失败
- **错误信息**：系统资源不足
- **处理方式**：程序继续运行，日志功能受限

### 🎯 错误通知设计原则

1. **用户友好**：所有错误信息都使用中文，通俗易懂
2. **具体指导**：每个错误都提供可能的原因和解决建议
3. **不影响主流程**：非关键错误不会导致程序崩溃
4. **分级处理**：
   - 致命错误：程序优雅退出
   - 重要错误：弹窗通知，用户确认后继续
   - 一般错误：记录日志，不影响使用

### 📋 错误通知格式

所有错误弹窗统一格式：
```
[错误标题]

[错误描述]

可能原因：
• [原因1]
• [原因2]
• [原因3]

[解决建议]
```

### 🔧 技术实现

所有错误通知都通过 `winapi::show_error_notification()` 函数实现：
- 使用Windows原生MessageBox API
- 支持多行文本和格式化
- 提供图标和按钮样式
- 跨平台兼容（Windows为主）

### 📝 测试建议

要测试这些错误处理功能，可以：

1. **模拟权限问题**：
   - 以普通用户身份运行程序
   - 尝试写入系统目录下的文件

2. **模拟文件问题**：
   - 删除config.toml文件
   - 将config.toml设置为只读
   - 删除res/wallpaper目录

3. **模拟系统问题**：
   - 卸载Chrome/Edge浏览器
   - 修改浏览器路径为无效路径

4. **查看日志**：
   - 所有错误都会记录在app.log中
   - 包含详细的错误堆栈和时间戳

### 🔄 后续扩展

未来可以添加：
- 更多系统级别的错误通知
- 错误恢复向导
- 一键修复功能
- 在线错误报告