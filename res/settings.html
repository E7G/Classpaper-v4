<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassPaper 设置</title>
    <script src="config/config.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        :root {
            /* Fluent Design Colors - Light Theme */
            --primary-color: #0078d4;
            --secondary-color: #106ebe;
            --success-color: #107c10;
            --danger-color: #d13438;
            --text-color: #323130;
            --bg-color: #faf9f8;
            --card-bg: #ffffff;
            --border-color: #edebe9;
            --hover-color: #f3f2f1;
            --accent-color: #0078d4;
            --subtle-border: #e1dfdd;
            --focus-color: #0078d4;
            --shadow-light: 0 1.6px 3.6px 0 rgba(0, 0, 0, 0.132), 0 0.3px 0.9px 0 rgba(0, 0, 0, 0.108);
            --shadow-medium: 0 3.2px 7.2px 0 rgba(0, 0, 0, 0.132), 0 0.6px 1.8px 0 rgba(0, 0, 0, 0.108);
            --shadow-heavy: 0 6.4px 14.4px 0 rgba(0, 0, 0, 0.132), 0 1.2px 3.6px 0 rgba(0, 0, 0, 0.108);
            --blur-bg: rgba(255, 255, 255, 0.85);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Fluent Design Colors - Dark Theme */
                --primary-color: #0078d4;
                --secondary-color: #106ebe;
                --success-color: #107c10;
                --danger-color: #d13438;
                --text-color: #faf9f8;
                --bg-color: #201f1e;
                --card-bg: #323130;
                --border-color: #484644;
                --hover-color: #3b3a39;
                --accent-color: #0078d4;
                --subtle-border: #484644;
                --focus-color: #2899f5;
                --shadow-light: 0 1.6px 3.6px 0 rgba(0, 0, 0, 0.26), 0 0.3px 0.9px 0 rgba(0, 0, 0, 0.22);
                --shadow-medium: 0 3.2px 7.2px 0 rgba(0, 0, 0, 0.26), 0 0.6px 1.8px 0 rgba(0, 0, 0, 0.22);
                --shadow-heavy: 0 6.4px 14.4px 0 rgba(0, 0, 0, 0.26), 0 1.2px 3.6px 0 rgba(0, 0, 0, 0.22);
                --blur-bg: rgba(50, 49, 48, 0.85);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 24px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 0;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            backdrop-filter: blur(10px);
            border: 1px solid var(--subtle-border);
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        p {

            color: var(--text-color);
            margin-bottom: 16px;
            font-weight: 600;
        }

        h1 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 24px;
            font-weight: 300;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-top: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        h3 {
            font-size: 16px;
            margin-top: 16px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
        }

        .form-section:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .settings-grid-full {
            grid-column: 1 / -1;
        }

        .tab-content {
            padding: 32px;
        }

        .tab-content h1 {
            margin-top: 0;
            margin-bottom: 32px;
            font-size: 28px;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .tab-content {
                padding: 16px;
            }
        }

        .form-section-title {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .form-section-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 400;
        }

        .checkbox-label input[type="checkbox"],
        .checkbox-label input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--primary-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, sans-serif;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
        }

        input:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        input:hover:not(:focus) {
            border-color: var(--subtle-border);
        }

        .help-text {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 4px;
            line-height: 1.4;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, sans-serif;
            transition: all 0.1s cubic-bezier(0.4, 0, 0.23, 1);
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button.primary {
            background-color: var(--primary-color);
            color: #ffffff;
        }

        button.primary:hover {
            background-color: #106ebe;
        }

        button.secondary {
            background-color: var(--hover-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        button.secondary:hover {
            background-color: var(--border-color);
        }

        button.add {
            background-color: var(--success-color);
            color: #ffffff;
        }

        button.add:hover {
            background-color: #0e700e;
        }

        button.delete {
            background-color: var(--danger-color);
            color: #ffffff;
            padding: 4px 12px;
            font-size: 12px;
            min-height: 28px;
        }

        button.delete:hover {
            background-color: #a72a2f;
        }

        button:hover {
            box-shadow: var(--shadow-light);
        }

        button:active {
            transform: scale(0.98);
        }

        button:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .tab-container {
            margin-bottom: 24px;
        }

        .tab-buttons {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            background-color: transparent;
            color: var(--text-color);
            font-weight: 600;
            font-size: 14px;
            font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, sans-serif;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
            border-right: 1px solid var(--border-color);
            position: relative;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: #ffffff;
        }

        .tab-button:hover:not(.active) {
            background-color: var(--hover-color);
        }

        .tab-button:focus {
            outline: none;
            z-index: 1;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.2s cubic-bezier(0.4, 0, 0.23, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        th {
            background-color: var(--hover-color);
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: var(--hover-color);
            transition: background-color 0.1s ease;
        }

        .event-list,
        .wallpaper-list {
            margin-bottom: 20px;
        }

        .event-item,
        .wallpaper-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
            box-shadow: var(--shadow-light);
        }

        .event-item:hover,
        .wallpaper-item:hover {
            box-shadow: var(--shadow-medium);
            background-color: var(--hover-color);
            transform: translateY(-1px);
        }

        .notice-editor {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, sans-serif;
            resize: vertical;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
        }

        .notice-editor:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3);
        }

        .preview-box {
            margin-top: 20px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--hover-color);
            box-shadow: var(--shadow-light);
        }

        .status {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.2s cubic-bezier(0.4, 0, 0.23, 1);
            z-index: 1000;
            box-shadow: var(--shadow-heavy);
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            word-wrap: break-word;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .status.success {
            background: rgba(16, 124, 16, 0.9);
            color: #ffffff;
            display: block;
            border-left: 4px solid #0e700e;
        }

        .status.error {
            background: rgba(209, 52, 56, 0.9);
            color: #ffffff;
            display: block;
            border-left: 4px solid #a72a2f;
        }

        .wallpaper-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
            box-shadow: var(--shadow-light);
        }

        .wallpaper-item:hover {
            background: var(--hover-color);
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }

        .wallpaper-thumb {
            width: 48px;
            height: 32px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--border-color);
        }

        .wallpaper-item input[type="text"] {
            flex: 1;
            min-width: 180px;
            max-width: 400px;
            padding: 6px 8px;
            font-size: 14px;
        }

        .wallpaper-item button.delete {
            background: var(--danger-color);
            color: #ffffff;
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            font-size: 12px;
        }

        /* Office风格表格样式 */
        #schedule .table-container {
            position: relative;
            touch-action: pan-y pinch-zoom;
        }

        .schedule-cell {
            position: relative;
            min-height: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .schedule-cell:hover {
            background-color: rgba(0, 120, 212, 0.1);
        }

        .schedule-cell.selected {
            background-color: rgba(0, 120, 212, 0.2);
            border: 1px solid var(--primary-color);
        }

        .schedule-cell.editing {
            padding: 0;
            background-color: #ffffff;
        }

        .schedule-cell input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 8px;
            font-size: 14px;
            background: transparent;
            outline: none;
        }

        .schedule-cell input:focus {
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        /* 触屏优化 */
        @media (pointer: coarse) {
            .schedule-cell {
                min-height: 48px;
                padding: 12px 8px;
            }
            
            .table-toolbar button {
                padding: 12px 16px;
                font-size: 16px;
            }
        }

        /* 拖拽样式 */
        .drag-over {
            background-color: rgba(0, 120, 212, 0.3) !important;
            border: 2px dashed var(--primary-color);
        }

        /* 批量选择样式 */
        .range-selected {
            background-color: rgba(0, 120, 212, 0.15);
        }

        /* 工具栏样式 */
        .table-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--hover-color);
            border-radius: 4px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            align-items: center;
            border-right: 1px solid var(--border-color);
            padding-right: 12px;
        }

        .toolbar-group:last-child {
            border-right: none;
            padding-right: 0;
        }

        .table-toolbar button {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .table-toolbar button:hover {
            background: var(--hover-color);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .table-toolbar button:active {
            transform: scale(0.95) translateY(0);
        }

        /* 搜索栏样式 - Fluent Design */
        .search-container {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--blur-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--subtle-border);
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
        }

        .search-bar {
            display: none;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            animation: fluent-slide-down 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
        }

        @keyframes fluent-slide-down {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 12px;
            transition: all 0.2s;
        }

        .search-input-group:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .search-input-group input[type="text"] {
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 14px;
            color: var(--text-color);
            outline: none;
            min-width: 200px;
        }

        .search-input-group input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        .search-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: var(--primary-color);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .search-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .search-button:active {
            transform: scale(0.95);
        }

        .search-button.secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .search-button.secondary:hover {
            background: var(--hover-color);
        }

        .search-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
            white-space: nowrap;
        }

        .search-highlight {
            background-color: rgba(255, 235, 59, 0.3) !important;
            border: 1px solid #ffeb3b !important;
        }

        .search-current {
            background-color: rgba(255, 193, 7, 0.5) !important;
            border: 2px solid #ffc107 !important;
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3);
        }

        /* 表格容器滚动 */
        .table-scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            box-shadow: var(--shadow-light);
        }

        .table-scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background: var(--bg-color);
            border-radius: 4px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Fluent Design 菜单样式 */
        .context-menu, .long-press-menu {
            position: fixed;
            background: var(--blur-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--subtle-border);
            border-radius: 8px;
            box-shadow: var(--shadow-heavy);
            z-index: 1002;
            display: none;
            min-width: 200px;
            font-size: 14px;
            max-height: 80vh;
            overflow: hidden;
            animation: fluent-menu-show 0.15s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
            transform-origin: top left;
            contain: layout style paint;
        }

        @keyframes fluent-menu-show {
            from {
                opacity: 0;
                transform: scale(0.96) translateY(-8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.1, 0.9, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-color);
            font-weight: 400;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            contain: layout style paint;
        }

        .context-menu-item:hover {
            background: var(--hover-color);
            color: var(--primary-color);
        }

        .context-menu-item:active {
            background: var(--primary-color);
            color: #ffffff;
            transform: scale(0.98);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 8px;
        }

        /* 分级菜单样式 - 修复子菜单展开问题 */
        .context-menu-item.has-submenu {
            position: relative;
        }

        .context-menu-item.has-submenu::after {
            content: '›';
            font-size: 16px;
            margin-left: 8px;
            transition: transform 0.2s ease;
            opacity: 0.7;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .context-menu-item.has-submenu:hover::after {
            transform: translateY(-50%) translateX(2px);
            opacity: 1;
        }

        .submenu {
            position: absolute;
            left: 100%;
            top: -4px;
            margin-left: 4px;
            background: var(--card-bg) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border-color) !important;
            border-radius: 8px;
            box-shadow: var(--shadow-heavy) !important;
            min-width: 180px;
            display: none !important;
            z-index: 10001 !important;
            animation: fluent-submenu-show 0.15s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
            transform-origin: left top;
            contain: layout style paint;
        }

        @keyframes fluent-submenu-show {
            from {
                opacity: 0;
                transform: scale(0.96) translateX(-8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateX(0);
            }
        }

        .context-menu-item.has-submenu:hover > .submenu {
            display: block !important;
        }
        
        .context-menu-item.has-submenu.active > .submenu {
            display: block !important;
        }
        
        .context-menu-item.active {
            background: var(--hover-color) !important;
            color: var(--primary-color) !important;
        }

        /* 子菜单项样式 */
        .submenu .context-menu-item {
            padding: 8px 12px !important;
            font-size: 13px !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .submenu .context-menu-item:last-child {
            border-bottom: none !important;
        }

        .submenu .context-menu-item:hover {
            background: var(--hover-color) !important;
            color: var(--primary-color) !important;
        }

        /* 菜单图标和快捷键 */
        .menu-icon {
            margin-right: 12px;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0.8;
        }

        .menu-shortcut {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.6;
            margin-left: 16px;
            font-weight: 400;
        }

        /* 菜单边界检测 */
        .context-menu.flipped-x .submenu {
            left: auto;
            right: 100%;
            margin-left: 0;
            margin-right: 4px;
            transform-origin: right top;
        }

        .context-menu.flipped-x .context-menu-item.has-submenu::after {
            content: '‹';
        }

        .context-menu.flipped-y .submenu {
            top: auto;
            bottom: -4px;
            transform-origin: left bottom;
        }

        /* 右键菜单响应式样式 */
        @media (max-width: 768px) {
            .context-menu, .long-press-menu {
                min-width: 220px;
                max-width: 90vw;
                border-radius: 8px;
                box-shadow: var(--shadow-heavy);
            }
            
            .context-menu-item {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .submenu {
                position: static;
                margin: 0;
                margin-top: 4px;
                margin-left: 16px;
                box-shadow: var(--shadow-light);
                animation: fluent-menu-show 0.15s ease;
                display: none; /* 确保初始状态为隐藏 */
            }
            
            .context-menu-item:hover > .submenu,
            .context-menu-item.active > .submenu {
                display: block;
            }
            
            .context-menu-item.has-submenu::after {
                content: '▼';
                font-size: 12px;
                transition: transform 0.2s ease;
            }
            
            .context-menu-item.active.has-submenu::after {
                transform: rotate(180deg);
            }
        }

        /* 表格选择区域 */
        .table-selection {
            position: absolute;
            background: rgba(0, 120, 212, 0.1);
            border: 1px solid var(--primary-color);
            pointer-events: none;
            z-index: 1000;
        }

        /* 调整手柄 */
        .resize-handle {
            position: absolute;
            width: 3px;
            height: 100%;
            right: 0;
            top: 0;
            cursor: col-resize;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .resize-handle:hover {
            opacity: 1;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.23, 1);
            min-height: 28px;
        }

        .wallpaper-item button.delete:hover {
            background: #a72a2f;
            box-shadow: var(--shadow-light);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .container {
                padding: 16px;
            }
            
            .status {
                top: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
                font-size: 13px;
                padding: 10px 16px;
            }

            .tab-buttons {
                flex-direction: column;
                border-radius: 6px;
            }

            .tab-button {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .tab-button:last-child {
                border-bottom: none;
            }

            .event-item,
            .wallpaper-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .table-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .toolbar-group {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
                border-right: none;
                padding-right: 0;
                gap: 4px;
            }

            .table-toolbar button {
                flex: 1;
                min-width: 60px;
                font-size: 11px;
                padding: 5px 8px;
            }

            button {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        #schedule .form-section {
            margin-bottom: 24px;
            box-shadow: var(--shadow-light);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 24px;
        }

        #schedule .form-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 16px;
            border-left: 3px solid var(--primary-color);
            padding-left: 12px;
        }

        #schedule .table-container {
            border-radius: 6px;
            overflow: auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            position: relative;
            touch-action: pan-y pinch-zoom;
        }

        #schedule table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #schedule th,
        #schedule td {
            padding: 8px 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        #schedule th {
            background: var(--hover-color);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        #schedule tr:last-child td {
            border-bottom: none;
        }

        #schedule tr:hover {
            background: var(--hover-color);
            transition: background-color 0.1s ease;
        }

        /* Office风格表格编辑功能 */
        .schedule-cell {
            position: relative;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .schedule-cell:hover {
            background: rgba(0, 120, 212, 0.1);
        }

        .schedule-cell.selected {
            background: rgba(0, 120, 212, 0.2);
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }

        .schedule-cell.editing {
            padding: 0;
            position: relative;
        }

        .schedule-cell input {
            width: 100%;
            height: 100%;
            border: none;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: inherit;
            font-family: inherit;
            padding: 8px;
            text-align: center;
            outline: none;
            box-shadow: inset 0 0 0 2px var(--primary-color);
        }

        .schedule-cell input:focus {
            box-shadow: inset 0 0 0 2px var(--primary-color), 0 0 0 1px rgba(0, 120, 212, 0.3);
        }

        /* 触屏优化 */
        @media (hover: none) and (pointer: coarse) {
            .schedule-cell {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .schedule-cell:active {
                background: rgba(0, 120, 212, 0.15);
                transform: scale(0.98);
                transition: all 0.1s ease;
            }
        }

        /* 拖放样式 */
        .schedule-cell.drag-over {
            background: rgba(0, 120, 212, 0.3);
            border: 2px dashed var(--primary-color);
        }

        /* 批量选择样式 */
        .schedule-cell.range-selected {
            background: rgba(0, 120, 212, 0.1);
        }

        /* 工具栏样式 */
        .table-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--hover-color);
            border-radius: 4px;
            align-items: center;
        }

        .table-toolbar button {
            padding: 4px 8px;
            font-size: 12px;
            min-height: 28px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .table-toolbar button:hover {
            background: var(--hover-color);
            border-color: var(--primary-color);
        }

        .table-toolbar button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 上下文菜单 - 修复显示问题 */
        .context-menu {
            position: fixed !important;
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 8px !important;
            box-shadow: var(--shadow-heavy) !important;
            z-index: 10000 !important;
            min-width: 200px !important;
            display: none !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .context-menu.show {
            display: block !important;
        }

        .context-menu-item {
            padding: 10px 16px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            border-bottom: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
            transition: all 0.2s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
        }

        .context-menu-item:last-child {
            border-bottom: none !important;
        }

        .context-menu-item:hover {
            background: var(--hover-color) !important;
            color: var(--primary-color) !important;
        }

        .context-menu-item:active {
            background: var(--primary-color) !important;
            color: white !important;
        }

        /* 触屏长按菜单 */
        .long-press-menu {
            position: fixed;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-heavy);
            z-index: 1001;
            display: none;
            min-width: 140px;
            padding: 4px 0;
        }

        .long-press-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .long-press-item:last-child {
            border-bottom: none;
        }

        .long-press-item:active {
            background: var(--hover-color);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* 表格选择样式 */
        .table-selection {
            position: absolute;
            background: rgba(0, 120, 212, 0.1);
            border: 1px solid var(--primary-color);
            pointer-events: none;
            z-index: 10;
        }

        /* 拖动调整大小手柄 */
        .resize-handle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--primary-color);
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .schedule-cell:hover .resize-handle {
            opacity: 1;
        }

        #schedule input[type="text"],
        #schedule input[type="time"] {
            width: 90px;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            font-size: 14px;
        }

        #schedule .add,
        #schedule .secondary {
            min-width: 90px;
            margin-right: 8px;
            font-size: 12px;
            padding: 4px 12px;
        }

        #schedule .form-group {
            margin-bottom: 16px;
        }

        #schedule .help-text {
            font-size: 12px;
            color: var(--secondary-color);
            line-height: 1.4;
        }

        #schedule .button-group {
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            #schedule .form-section {
                padding: 16px;
            }

            #schedule input[type="text"],
            #schedule input[type="time"] {
                width: 70px;
                font-size: 12px;
            }
        }

        /* 可编辑单元格样式 */
        .schedule-cell {
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            transition: background-color 0.2s ease;
        }

        .schedule-cell:hover {
            background-color: rgba(0, 120, 212, 0.1) !important;
        }

        .schedule-cell:focus {
            outline: 2px solid #0078d4;
            outline-offset: -2px;
            background-color: white !important;
        }

        .schedule-cell[contenteditable="true"]:focus {
            background-color: white !important;
            box-shadow: inset 0 0 0 1px #0078d4;
        }

        .edit-input {
            font-family: inherit;
            font-size: inherit;
            color: var(--text-color) !important;
            background: var(--card-bg) !important;
            border: 2px solid var(--primary-color) !important;
            outline: none;
            text-align: center;
            padding: 8px;
            margin: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            display: block;
            border-radius: 4px;
        }

        .edit-input:focus {
            color: var(--text-color) !important;
            background: var(--card-bg) !important;
            border-color: var(--focus-color) !important;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.3) !important;
        }

        .schedule-cell.editing {
            padding: 0 !important;
            background: white !important;
            box-shadow: inset 0 0 0 2px #0078d4;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 48px 32px; text-align: center; margin-bottom: 0;">
            <h1 style="margin: 0; font-size: 32px; font-weight: 300; letter-spacing: -0.5px;">ClassPaper 设置</h1>
            <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 16px;">一纸素笺绘春秋，方寸之间容万象； 课表轻展如画卷，壁纸流转似流光。</p>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('basic')">基本设置</button>
                <button class="tab-button" onclick="switchTab('schedule')">课程表</button>
                <button class="tab-button" onclick="switchTab('events')">事件</button>
                <button class="tab-button" onclick="switchTab('wallpapers')">壁纸</button>
                <button class="tab-button" onclick="switchTab('notice')">告示牌</button>
            </div>
        </div>

        <div id="basic" class="tab-content active">
            <div class="settings-grid">
            <div class="form-section">
                <div class="form-section-title">
                    <h2>进度条设置</h2>
                </div>
                <div class="form-group">
                    <label for="progress-description">进度条自定义描述</label>
                    <input type="text" id="progress-description" maxlength="30" placeholder="如：高三剩余、距离毕业、距离高考...">
                    <div class="help-text">设置主界面进度条下方的自定义描述文本，支持任意内容。</div>
                </div>
                <div class="form-group">
                    <label for="semester-begin">进度条事件开始时间</label>
                    <input type="date" id="semester-begin">
                    <div class="help-text">设置进度条事件的开始日期</div>
                </div>
                <div class="form-group">
                    <label for="semester-end">进度条事件结束时间</label>
                    <input type="date" id="semester-end">
                    <div class="help-text">设置进度条事件的结束日期</div>
                </div>
                <div class="form-group">
                    <label>百分比显示方式</label>
                    <label class="checkbox-label" style="margin-right: 18px;">
                        <input type="radio" name="progress-percent-mode" id="progress-percent-left" value="left"
                            checked>
                        显示剩余百分比
                    </label>
                    <label class="checkbox-label">
                        <input type="radio" name="progress-percent-mode" id="progress-percent-passed" value="passed">
                        显示已过百分比
                    </label>
                    <div class="help-text">可切换进度条下方显示“剩余”或“已过”百分比。</div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">
                    <h2>周数设置</h2>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="week-offset-enabled">
                        启用自定义周数
                    </label>
                    <div class="help-text">开启后可以自定义显示的周数</div>
                </div>
                <div class="form-group">
                    <label for="week-offset">周数偏移值</label>
                    <input type="number" id="week-offset" min="0" max="52">
                    <div class="help-text">实际显示的周数 = 本年第几周 - 偏移值。例如：如果现在是本年第9周，偏移值为7，则显示为第2周。</div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">
                    <h2>提示音设置</h2>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="notifications-enabled">
                        启用课堂提示音
                    </label>
                    <div class="help-text">开启后会在上课期间定期播放提示音</div>
                </div>
                <div class="form-group">
                    <label for="regular-interval">常规提示间隔（分钟）</label>
                    <input type="number" id="regular-interval" min="1" max="30">
                    <div class="help-text">设置两次提示音之间的时间间隔</div>
                </div>
                <div class="form-group">
                    <label for="ending-time">结束提示时间（分钟）</label>
                    <input type="number" id="ending-time" min="1" max="30">
                    <div class="help-text">设置课程结束前多少分钟播放结束提示音</div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">
                    <h2>系统设置</h2>
                </div>
        <div class="form-group">
                    <label for="url">壁纸页面URL</label>
            <input type="text" id="url" placeholder="输入页面URL或本地文件路径">
                    <div class="help-text">可以是网页地址或本地壁纸文件夹路径</div>
                </div>
                <div class="form-group">
                    <label for="browser">浏览器路径（可选）</label>
                    <input type="text" id="browser" placeholder="输入Chrome浏览器路径">
                    <div class="help-text">如果系统无法自动找到Chrome浏览器，请手动指定路径</div>
                </div>
                <!-- 新增调试按钮 -->
                <button class="secondary" onclick="openInBrowser()">在浏览器中打开调试</button>
                </div>
            </div>
        </div>

        <div id="schedule" class="tab-content">
            <div class="settings-grid">
                <div class="form-section settings-grid-full">
                    <div class="form-section-title">
                        <h2>课程时间安排</h2>
                    </div>
                    <div style="display:flex;align-items:center;gap:18px;margin-bottom:10px;">
                        <button class="add" onclick="smartGuessTimeTable()">智能推算</button>
                        <span class="help-text">一键根据已填时间智能补全后续节次时间，可根据实际情况手动微调。</span>
                    </div>
                    <div class="table-container">
                        <table id="timeTable">
                            <thead>
                                <tr>
                                    <th>节次</th>
                                    <th>上课时间</th>
                                    <th>下课时间</th>
                                    <th>休息时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <button class="add" onclick="addTimeSlot()">添加时间段</button>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <h2>课表显示模式</h2>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="radio" name="display-mode" id="display-mode-scroll" value="scroll">
                            滚动模式（当前课程居中，前后天填充空白）
                        </label>
                        <label class="checkbox-label">
                            <input type="radio" name="display-mode" id="display-mode-day" value="day">
                            一天进度模式（只显示当天全部课程，按时间高亮）
                        </label>
                        <div class="help-text">选择课表的显示方式，滚动模式适合大屏，进度模式适合移动端或简洁需求。</div>
                    </div>
                </div>

                <div class="form-section settings-grid-full">
                        <div class="form-section-title">
                            <h2>课程安排</h2>
                        </div>
                        <div class="form-group">
                            <label for="schedule-import">导入课程表</label>
                            <textarea id="schedule-import" class="notice-editor" style="min-height: 100px;" placeholder="粘贴课程表文本，格式如下：
星期,1,2,3,4,5,6,7,8,9,10,11,
周一,升旗,班会,物理,英语,数学,数学,生物,化学,语文,晚修,晚修,
周二,语文,语文,数学,英语,体育,物理,生物,化学,自习,晚修,晚修,
..."></textarea>
                            <div class="help-text">支持CSV格式的课程表文本导入，第一行为表头，之后每行为一天的课程安排</div>
                            <button class="secondary" onclick="importSchedule()">导入课程表</button>
                        </div>
                        
                        <!-- Office风格工具栏 -->
                        <div class="table-toolbar" id="tableToolbar">
                            <div class="toolbar-group">
                                <button onclick="addRow()" title="添加行">➕ 行</button>
                                <button onclick="addColumn()" title="添加列">➕ 列</button>
                                <button onclick="deleteRow()" title="删除行">🗑️ 删行</button>
                                <button onclick="deleteColumn()" title="删除列">🗑️ 删列</button>
                            </div>
                            <div class="toolbar-group">
                                <button onclick="copyCells()" title="复制">📋 复制</button>
                                <button onclick="pasteCells()" title="粘贴">📌 粘贴</button>
                                <button onclick="clearCells()" title="清空内容">🗑️ 清空</button>
                            </div>
                            <div class="toolbar-group">
                                <button onclick="mergeCells()" title="合并单元格">🔗 合并</button>
                                <button onclick="splitCell()" title="拆分单元格">✂️ 拆分</button>
                                <button onclick="fillSeries()" title="填充序列">📊 序列</button>
                                <button onclick="autoFitColumns()" title="自动调整列宽">📏 自适应</button>
                            </div>
                            <div class="toolbar-group">
                                <button onclick="undoAction()" title="撤销">↩️ 撤销</button>
                                <button onclick="redoAction()" title="重做">↪️ 重做</button>
                                <button onclick="toggleSearchBar()" title="查找替换">🔍 查找</button>
                                <div class="search-bar" id="searchBar" style="display: none;">
                                    <input type="text" id="searchInput" placeholder="查找..." onkeydown="handleSearchKeydown(event)">
                                    <input type="text" id="replaceInput" placeholder="替换为...">
                                    <button onclick="findNext()" title="查找下一个">⬇️</button>
                                    <button onclick="findPrevious()" title="查找上一个">⬆️</button>
                                    <button onclick="replaceCurrent()" title="替换">🔄</button>
                                    <button onclick="replaceAll()" title="全部替换">🔄🔄</button>
                                    <button onclick="closeSearchBar()" title="关闭">❌</button>
                                </div>
                            </div>
                            <div class="toolbar-group">
                                <button onclick="exportData()" title="导出CSV">📤 导出</button>
                                <button onclick="importData()" title="导入CSV">📥 导入</button>
                            </div>
                        </div>
                        
                        <div class="table-scroll-container">
                            <table id="scheduleTable">
                                <thead>
                                    <tr>
                                        <th>星期/节次</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        
                </div>
            </div>
        </div>

        <div id="events" class="tab-content">
            <div class="settings-grid">
                <div class="form-section settings-grid-full">
                    <div class="form-section-title">
                        <h2>事件列表</h2>
                    </div>
                    <div class="event-list" id="eventList">
                    </div>
                    <button class="add" onclick="addEvent()">添加事件</button>
                </div>
            </div>
        </div>

        <div id="wallpapers" class="tab-content">
            <div class="settings-grid">
                <div class="form-section settings-grid-full">
                    <div class="form-section-title">
                        <h2>壁纸管理</h2>
                    </div>
                    <div class="wallpaper-list" id="wallpaperList" style="margin-bottom: 24px;">
                        <!-- 动态生成壁纸项，每项含缩略图、路径输入、删除按钮 -->
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end;">
                        <div class="form-group" style="margin: 0;">
                            <label for="wallpaper-interval">切换间隔（秒）</label>
                            <input type="number" id="wallpaper-interval" min="5" max="3600" step="1" value="30"
                                style="width: 120px;">
                            <div class="help-text">壁纸自动切换的时间间隔，建议不小于5秒</div>
                        </div>
                        <div class="button-group" style="justify-content: flex-start; gap: 16px; margin: 0;">
                            <button class="secondary" onclick="scanWallpapers()">扫描壁纸文件夹</button>
                            <button class="add" onclick="addWallpaper()">添加壁纸</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notice" class="tab-content">
            <div class="settings-grid">
                <div class="form-section settings-grid-full">
                    <div class="form-section-title">
                        <h2>告示内容</h2>
                    </div>
                    <div class="form-group">
                        <label for="notice-content">告示内容（支持HTML）</label>
                        <textarea id="notice-content" class="notice-editor" placeholder="在这里输入告示内容，支持HTML标签"
                            oninput="updatePreview()"></textarea>
                    </div>
                    <div class="preview-box">
                        <h3>预览</h3>
                        <div id="notice-preview"></div>
                    </div>
                </div>
            </div>
        </div>
<!-- 
        <div id="status" class="status"></div> -->

        <style>
        /* Fluent Design Dialog Styles */
        .fluent-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.32);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fluentFadeIn 0.2s ease-out;
        }

        .fluent-dialog {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-heavy);
            min-width: 400px;
            max-width: 500px;
            margin: 16px;
            overflow: hidden;
            animation: fluentSlideIn 0.3s ease-out;
        }

        .fluent-dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .fluent-dialog-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
        }

        .fluent-dialog-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.6;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }

        .fluent-dialog-close:hover {
            opacity: 1;
        }

        .fluent-dialog-content {
            padding: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .fluent-dialog-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .fluent-dialog-message h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .fluent-dialog-message p {
            margin: 0;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.5;
        }

        .fluent-dialog-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .fluent-button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 32px;
        }

        .fluent-button-primary {
            background: var(--primary-color);
            color: #ffffff;
        }

        .fluent-button-primary:hover {
            background: #106ebe;
        }

        .fluent-button-secondary {
            background: var(--hover-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .fluent-button-secondary:hover {
            background: var(--border-color);
        }

        .fluent-button-danger {
            background: var(--danger-color);
            color: #ffffff;
        }

        .fluent-button-danger:hover {
            background: #a72a2f;
        }

        @keyframes fluentFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fluentSlideIn {
            from { 
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @media (max-width: 768px) {
            .fluent-dialog {
                min-width: 300px;
                margin: 16px;
            }
            
            .fluent-dialog-content {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            
            .fluent-dialog-icon {
                margin: 0 auto;
            }
        }
        </style>

        <div class="button-group">
            <button class="secondary" onclick="showResetDialog()">重置</button>
            <button class="primary" onclick="handleSave()">保存</button>
        </div>
    </div>

    <script>
        let currentConfig = null;

        function switchTab(tabId) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // 取消所有标签按钮的激活状态
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // 显示选中的标签页内容
            document.getElementById(tabId).classList.add('active');
            // 激活对应的标签按钮
            document.querySelector(`.tab-button[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }

        // 检查函数是否已绑定
        function waitForBinding(funcName) {
            return new Promise((resolve) => {
                const check = () => {
                    if (typeof window[funcName] === 'function') {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                };
                check();
            });
        }

        // 扫描壁纸文件夹
        async function scanWallpapers() {
            try {
                await waitForBinding('scanWallpaperDir');

                if (typeof window.scanWallpaperDir !== 'function') {
                    throw new Error('scanWallpaperDir 函数未定义');
                }

                const wallpapers = await window.scanWallpaperDir();
                if (Array.isArray(wallpapers)) {
                    // 获取现有壁纸列表
                    const container = document.getElementById('wallpaperList');
                    const existingItems = Array.from(container.children);

                    // 规范化路径（移除前导./，统一分隔符，确保相对于index.html）
                    const normalizePath = (path) => {
                        // 移除前导./和res/
                        return path.replace(/^\.\//, '')
                            .replace(/^res\//, '')
                            .replace(/\\/g, '/');
                    };

                    const existingPaths = new Set(
                        existingItems.map(item =>
                            normalizePath(item.querySelector('input').value)
                        )
                    );

                    // 只添加不存在的壁纸
                    let addedCount = 0;
                    wallpapers.forEach(wallpaper => {
                        const normalizedPath = normalizePath(wallpaper);
                        if (!existingPaths.has(normalizedPath)) {
                            container.innerHTML += `
                                <div class="wallpaper-item">
                                    <input type="text" placeholder="壁纸路径" value="${wallpaper}">
                                    <button class="delete" onclick="deleteWallpaper(${container.children.length})">删除</button>
                                </div>
                            `;
                            addedCount++;
                        }
                    });

                    if (addedCount > 0) {
                        showStatus(`已添加 ${addedCount} 个新壁纸`, 'success');
                    } else {
                        showStatus('没有发现新的壁纸', 'success');
                    }
                } else {
                    throw new Error('无效的壁纸列表数据');
                }
            } catch (e) {
                console.error('扫描壁纸文件夹失败:', e);
                showStatus('扫描壁纸文件夹失败: ' + e, 'error');
            }
        }

        // 初始化课程表
        function initScheduleTable(config) {
            const table = document.getElementById('scheduleTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');

            // 清空现有内容
            thead.innerHTML = '<th>星期/节次</th>';
            tbody.innerHTML = '';

            // 添加表头
            config.lessons.headers.slice(1).forEach(header => {
                thead.innerHTML += `<th>${header}</th>`;
            });

            // 添加表格内容
            config.lessons.schedule.forEach(day => {
                const row = document.createElement('tr');
                const dayCell = document.createElement('td');
                dayCell.className = 'schedule-day';
                dayCell.textContent = day.day;
                dayCell.style.fontWeight = 'bold';
                row.appendChild(dayCell);
                
                day.classes.forEach(lesson => {
                    const cell = document.createElement('td');
                    cell.className = 'schedule-cell';
                    cell.textContent = lesson;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }

        // 初始化事件列表
        function initEventList(events) {
            const container = document.getElementById('eventList');
            container.innerHTML = '';
            events.forEach((event, index) => {
                container.innerHTML += `
                    <div class="event-item">
                        <input type="text" placeholder="事件名称" value="${event.name}">
                        <input type="datetime-local" value="${event.date.split('T')[0]}T${event.date.split('T')[1].split('.')[0]}">
                        <button class="delete" onclick="deleteEvent(${index})">删除</button>
                    </div>
                `;
            });
        }

        // 初始化壁纸列表
        function initWallpaperList(wallpapers) {
            const container = document.getElementById('wallpaperList');
            container.innerHTML = '';
            wallpapers.forEach((wallpaper, index) => {
                // 支持本地相对路径缩略图
                let thumbSrc = wallpaper;
                if (!/^https?:\/\//.test(wallpaper) && !/^data:/.test(wallpaper)) {
                    thumbSrc = wallpaper.replace(/^\.\//, '').replace(/^res\//, '');
                }
                container.innerHTML += `
                    <div class="wallpaper-item">
                        <img class="wallpaper-thumb" src="${thumbSrc}" alt="预览" onerror="this.src='icon/icon.png'">
                        <input type="text" placeholder="壁纸路径" value="${wallpaper}">
                        <button class="delete" onclick="deleteWallpaper(${index})">删除</button>
                    </div>
                `;
            });
        }

        // 添加事件
        function addEvent() {
            const container = document.getElementById('eventList');
            const now = new Date().toISOString().slice(0, 16);
            container.innerHTML += `
                <div class="event-item">
                    <input type="text" placeholder="事件名称">
                    <input type="datetime-local" value="${now}">
                    <button class="delete" onclick="deleteEvent(${container.children.length})">删除</button>
                </div>
            `;
        }

        // 删除事件
        function deleteEvent(index) {
            const container = document.getElementById('eventList');
            container.children[index].remove();
        }

        // 添加壁纸
        function addWallpaper() {
            const container = document.getElementById('wallpaperList');
            container.innerHTML += `
                <div class="wallpaper-item">
                    <input type="text" placeholder="相对于index.html的壁纸路径，例如：wallpaper/bg.jpg">
                    <button class="delete" onclick="deleteWallpaper(${container.children.length})">删除</button>
                </div>
            `;
        }

        // 删除壁纸
        function deleteWallpaper(index) {
            const container = document.getElementById('wallpaperList');
            container.children[index].remove();
        }

        // 初始化告示内容
        function initNotice(sth) {
            document.getElementById('notice-content').value = sth || '';
            updatePreview();
        }

        // 更新预览（优化：支持多行换行显示）
        function updatePreview() {
            const content = document.getElementById('notice-content').value;
            // 支持多行换行显示
            document.getElementById('notice-preview').innerHTML = content.replace(/\n/g, '<br>');
        }

        // 收集课程表数据
        function getScheduleData() {
            const tbody = document.getElementById('scheduleTable').querySelector('tbody');
            const schedule = [];

            Array.from(tbody.children).forEach(row => {
                const day = row.cells[0].textContent.trim();
                const classes = Array.from(row.cells).slice(1).map(cell => cell.textContent.trim());
                schedule.push({ day, classes });
            });

            return schedule;
        }

        // 收集事件数据
        function getEventData() {
            const container = document.getElementById('eventList');
            const events = [];
            Array.from(container.children).forEach(item => {
                const inputs = item.querySelectorAll('input');
                events.push({
                    name: inputs[0].value,
                    date: inputs[1].value + ':00'
                });
            });
            return events;
        }

        // 收集壁纸数据
        function getWallpaperData() {
            const container = document.getElementById('wallpaperList');
            return Array.from(container.children).map(item => item.querySelector('input').value);
        }

        // 获取告示内容
        function getNoticeData() {
            return document.getElementById('notice-content').value;
        }

        // 添加时间段
        function addTimeSlot() {
            const tbody = document.getElementById('timeTable').querySelector('tbody');
            const newRow = document.createElement('tr');
            const period = tbody.children.length + 1;
            newRow.innerHTML = `
                <td>${period}</td>
                <td><input type="time" class="time-begin"></td>
                <td><input type="time" class="time-end"></td>
                <td><input type="time" class="rest-begin"> - <input type="time" class="rest-end"></td>
                <td><button class="delete" onclick="deleteTimeSlot(this)">删除</button></td>
            `;
            tbody.appendChild(newRow);
        }

        // 删除时间段
        function deleteTimeSlot(button) {
            const row = button.closest('tr');
            row.remove();
            // 重新编号
            const tbody = document.getElementById('timeTable').querySelector('tbody');
            Array.from(tbody.children).forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }

        // 初始化时间表
        function initTimeTable(config) {
            const tbody = document.getElementById('timeTable').querySelector('tbody');
            tbody.innerHTML = '';

            config.lessons.times.schedule.forEach(slot => {
                const row = document.createElement('tr');
                const [restBegin, restEnd] = slot.rest ? slot.rest.split('-') : ['', ''];
                row.innerHTML = `
                    <td>${slot.period}</td>
                    <td><input type="time" class="time-begin" value="${slot.begin}"></td>
                    <td><input type="time" class="time-end" value="${slot.end}"></td>
                    <td><input type="time" class="rest-begin" value="${restBegin}"> - <input type="time" class="rest-end" value="${restEnd}"></td>
                    <td><button class="delete" onclick="deleteTimeSlot(this)">删除</button></td>
                `;
                tbody.appendChild(row);
            });
        }


        // 获取时间表数据
        function getTimeData() {
            const tbody = document.getElementById('timeTable').querySelector('tbody');
            const schedule = [];

            Array.from(tbody.children).forEach(row => {
                const period = parseInt(row.cells[0].textContent);
                const begin = row.querySelector('.time-begin').value;
                const end = row.querySelector('.time-end').value;
                const restBegin = row.querySelector('.rest-begin').value;
                const restEnd = row.querySelector('.rest-end').value;

                schedule.push({
                    period: period,
                    begin: begin,
                    end: end,
                    rest: restBegin && restEnd ? `${restBegin}-${restEnd}` : null
                });
            });

            return schedule;
        }

        // 导入课程表
        function importSchedule() {
            try {
                const importText = document.getElementById('schedule-import').value.trim();
                if (!importText) {
                    showStatus('请输入课程表文本', 'error');
                    return;
                }

                // 按行分割
                const lines = importText.split('\n');
                if (lines.length < 2) {
                    showStatus('课程表格式不正确', 'error');
                    return;
                }

                // 解析表头
                let headers = lines[0].split(',').map(h => h.trim());
                // 如果表头最后一个元素为空，则去除
                if (headers.length > 0 && headers[headers.length - 1] === '') {
                    headers.pop();
                }
                headers = headers.filter(h => h);
                if (headers.length < 2) {
                    showStatus('课程表表头格式不正确', 'error');
                    return;
                }

                // 解析课程数据
                const schedule = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    let cells = line.split(',').map(c => c.trim());
                    // 如果最后一个元素为空，则去除
                    if (cells.length > 0 && cells[cells.length - 1] === '') {
                        cells.pop();
                    }
                    if (cells.length < 2) continue;

                    schedule.push({
                        day: cells[0],
                        classes: cells.slice(1)
                    });
                }

                if (schedule.length === 0) {
                    showStatus('没有找到有效的课程数据', 'error');
                    return;
                }

                // 更新CONFIG
                CONFIG.lessons.headers = headers;
                CONFIG.lessons.schedule = schedule;

                // 重新初始化课程表
                initScheduleTable(CONFIG);
                showStatus('课程表导入成功', 'success');
            } catch (e) {
                console.error('导入课程表失败:', e);
                showStatus('导入课程表失败: ' + e, 'error');
            }
        }

        // 重命名函数以避免冲突
        async function handleSave() {
            try {
                // 等待所有必要的函数绑定
                await Promise.all([
                    waitForBinding('saveConfig'),
                    waitForBinding('writeFile'),
                    waitForBinding('reloadMainWindow')
                ]);

                // 确保CONFIG已经加载
                if (typeof CONFIG === 'undefined') {
                    showStatus('保存失败：CONFIG未定义', 'error');
                    return;
                }

                // 更新CONFIG对象
                CONFIG.lessons.schedule = getScheduleData();
                CONFIG.lessons.times.schedule = getTimeData();
                CONFIG.lessons.times.semester = {
                    begin: document.getElementById('semester-begin').value,
                    end: document.getElementById('semester-end').value
                };

                // 保存提示音设置
                CONFIG.notifications = {
                    enabled: document.getElementById('notifications-enabled').checked,
                    regularInterval: parseInt(document.getElementById('regular-interval').value) || 5,
                    endingTime: parseInt(document.getElementById('ending-time').value) || 5
                };

                // 保存周数设置
                CONFIG.weekOffset = {
                    enabled: document.getElementById('week-offset-enabled').checked,
                    offset: parseInt(document.getElementById('week-offset').value) || 7
                };
                CONFIG.events = getEventData();
                CONFIG.wallpapers = getWallpaperData();
                CONFIG.sth = getNoticeData();

                // 保存课表显示模式
                CONFIG.lessons.displayMode = document.getElementById('display-mode-scroll').checked ? 'scroll' : 'day';

                // 保存壁纸切换间隔
                CONFIG.wallpaperInterval = parseInt(document.getElementById('wallpaper-interval').value) || 30;

                // 保存进度条描述
                CONFIG.progressDescription = document.getElementById('progress-description').value.trim();

                // 保存百分比显示方式
                CONFIG.progressPercentMode = document.getElementById('progress-percent-left').checked ? 'left' : 'passed';

                // 保存config.js
                const configContent = `const CONFIG = ${JSON.stringify(CONFIG, null, 2)};
`;

                try {
                    if (typeof window.writeFile !== 'function') {
                        throw new Error('writeFile 函数未定义');
                    }
                    await window.writeFile('res/config/config.js', configContent);
                } catch (e) {
                    console.error('保存config.js失败:', e);
                    showStatus('保存config.js失败: ' + e, 'error');
                    return;
                }

                // 保存config.toml
                const basicConfig = {
                    Default: {
                        URL: document.getElementById('url').value.trim(),
                        BrowserPath: document.getElementById('browser').value.trim()
                    }
                };

                try {
                    if (typeof window.saveConfig !== 'function') {
                        throw new Error('saveConfig 函数未定义');
                    }
                    await window.saveConfig(JSON.stringify(basicConfig));

                    // 重新加载配置并刷新主窗口
                    await handleReset();

                    // 刷新主窗口
                    if (typeof window.reloadMainWindow === 'function') {
                        await window.reloadMainWindow();
                        showStatus('配置已保存并刷新主窗口', 'success');
                    } else {
                        showStatus('配置已保存（主窗口刷新失败）', 'success');
                    }
                } catch (e) {
                    console.error('保存config.toml失败:', e);
                    showStatus('保存config.toml失败: ' + e, 'error');
                }
            } catch (e) {
                console.error('保存配置失败:', e);
                showStatus('保存配置失败: ' + e, 'error');
            }
        }

        // 重命名函数以避免冲突
        async function handleReset() {
            try {
                await waitForBinding('readConfig');

                if (typeof window.readConfig !== 'function') {
                    throw new Error('readConfig 函数未定义');
                }
                
                const config = await window.readConfig();
                currentConfig = config;

                if (config && config.Default) {
                    document.getElementById('url').value = config.Default.URL || '';
                    document.getElementById('browser').value = config.Default.BrowserPath || '';

                    if (typeof CONFIG !== 'undefined') {
                        // 设置学期时间
                        document.getElementById('semester-begin').value = CONFIG.lessons.times.semester.begin;
                        document.getElementById('semester-end').value = CONFIG.lessons.times.semester.end;

                        // 加载提示音设置
                        document.getElementById('notifications-enabled').checked = CONFIG.notifications.enabled;
                        document.getElementById('regular-interval').value = CONFIG.notifications.regularInterval;
                        document.getElementById('ending-time').value = CONFIG.notifications.endingTime;

                        // 加载周数设置
                        document.getElementById('week-offset-enabled').checked = CONFIG.weekOffset.enabled;
                        document.getElementById('week-offset').value = CONFIG.weekOffset.offset;

                        initTimeTable(CONFIG);
                        initScheduleTable(CONFIG);
                        initEventList(CONFIG.events);
                        initWallpaperList(CONFIG.wallpapers);
                        initNotice(CONFIG.note);

                        // 加载课表显示模式
                        if (CONFIG.lessons.displayMode === 'day') {
                            document.getElementById('display-mode-day').checked = true;
                        } else {
                            document.getElementById('display-mode-scroll').checked = true;
                        }

                        // 加载壁纸切换间隔
                        document.getElementById('wallpaper-interval').value = CONFIG.wallpaperInterval || 30;

                        // 加载进度条描述
                        document.getElementById('progress-description').value = CONFIG.progressDescription || '';

                        // 加载百分比显示方式
                        if (CONFIG.progressPercentMode === 'left') {
                            document.getElementById('progress-percent-left').checked = true;
                        } else {
                            document.getElementById('progress-percent-passed').checked = true;
                        }
                    } else {
                        showStatus('配置加载失败：CONFIG未定义', 'error');
                    }

                    showStatus('配置已加载', 'success');
                } else {
                    showStatus('配置格式不正确', 'error');
                }
            } catch (e) {
                console.error('加载配置失败:', e);
                showStatus('加载配置失败: ' + e, 'error');
            }
        }

        function confirmReset() {
            if (window.confirm('确定要重置并重新加载所有设置吗？未保存的更改将丢失。')) {
                handleReset();
            }
        }

        // 显示状态信息
        function showStatus(message, type) {
            let status = document.getElementById('status');
            if (!status) {
                // 如果状态元素不存在，创建一个
                status = document.createElement('div');
                status.id = 'status';
                status.className = 'status';
                document.body.appendChild(status);
            }
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        async function showResetDialog() {
            const confirmed = await showFluentDialog({
                title: '确认重置',
                message: '确定要重置并重新加载所有设置吗？未保存的更改将丢失。',
                confirmText: '重置',
                cancelText: '取消',
                type: 'danger'
            });
            
            if (confirmed) {
                handleReset();
            }
        }

        // 全局的Fluent Design对话框函数
        function showFluentDialog(options) {
            return new Promise((resolve) => {
                // 创建对话框元素
                const dialog = document.createElement('div');
                dialog.className = 'fluent-dialog-overlay';
                dialog.innerHTML = `
                    <div class="fluent-dialog">
                        <div class="fluent-dialog-header">
                            <div class="fluent-dialog-icon">${options.type === 'danger' ? '⚠️' : options.type === 'info' ? 'ℹ️' : '❓'}</div>
                            <h3 class="fluent-dialog-title">${options.title || '确认'}</h3>
                            <button class="fluent-dialog-close" onclick="this.closest('.fluent-dialog-overlay').remove()">×</button>
                        </div>
                        <div class="fluent-dialog-content">
                            <p class="fluent-dialog-message">${options.message || ''}</p>
                        </div>
                        <div class="fluent-dialog-footer">
                            <button class="fluent-button fluent-button-secondary" onclick="this.closest('.fluent-dialog-overlay').remove(); window.__fluentDialogResolve(false);">${options.cancelText || '取消'}</button>
                            <button class="fluent-button ${options.type === 'danger' ? 'fluent-button-danger' : 'fluent-button-primary'}" onclick="this.closest('.fluent-dialog-overlay').remove(); window.__fluentDialogResolve(true);">${options.confirmText || '确定'}</button>
                        </div>
                    </div>
                `;
                
                // 添加样式
                if (!document.querySelector('#fluent-dialog-styles')) {
                    const style = document.createElement('style');
                    style.id = 'fluent-dialog-styles';
                    style.textContent = `
                        .fluent-dialog-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.32);
                            backdrop-filter: blur(8px);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            animation: fadeIn 0.15s ease-out;
                        }
                        
                        .fluent-dialog {
                            background: var(--card-bg);
                            border-radius: 12px;
                            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.24), 0 0 0 1px rgba(255, 255, 255, 0.08);
                            min-width: 400px;
                            max-width: 520px;
                            margin: 20px;
                            animation: slideUp 0.2s ease-out;
                            border: 1px solid rgba(255, 255, 255, 0.1);
                            overflow: hidden;
                        }
                        
                        .fluent-dialog-header {
                            display: flex;
                            align-items: center;
                            padding: 20px 24px 0;
                            gap: 12px;
                        }
                        
                        .fluent-dialog-icon {
                            font-size: 20px;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            flex-shrink: 0;
                        }
                        
                        .fluent-dialog-title {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0;
                            color: var(--text-color);
                            flex: 1;
                        }
                        
                        .fluent-dialog-close {
                            background: none;
                            border: none;
                            font-size: 20px;
                            cursor: pointer;
                            color: var(--text-color-secondary);
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                            transition: all 0.15s ease;
                        }
                        
                        .fluent-dialog-close:hover {
                            background: var(--hover-color);
                            color: var(--text-color);
                        }
                        
                        .fluent-dialog-content {
                            padding: 8px 24px 24px;
                        }
                        
                        .fluent-dialog-message {
                            font-size: 15px;
                            color: var(--text-color-secondary);
                            line-height: 1.5;
                            margin: 0;
                        }
                        
                        .fluent-dialog-footer {
                            display: flex;
                            gap: 12px;
                            justify-content: flex-end;
                            padding: 0 24px 20px;
                        }
                        
                        .fluent-button {
                            padding: 8px 16px;
                            border: 1px solid var(--border-color);
                            border-radius: 6px;
                            background: var(--card-bg);
                            color: var(--text-color);
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.15s ease;
                            font-family: inherit;
                            min-width: 80px;
                            height: 36px;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                        }
                        
                        .fluent-button:hover {
                            background: var(--hover-color);
                            border-color: var(--border-color-hover);
                        }
                        
                        .fluent-button:active {
                            transform: scale(0.98);
                        }
                        
                        .fluent-button-primary {
                            background: var(--primary-color);
                            color: white;
                            border-color: var(--primary-color);
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                        }
                        
                        .fluent-button-primary:hover {
                            background: var(--secondary-color);
                            border-color: var(--secondary-color);
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                        }
                        
                        .fluent-button-danger {
                            background: var(--danger-color);
                            color: white;
                            border-color: var(--danger-color);
                            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                        }
                        
                        .fluent-button-danger:hover {
                            background: #a4262c;
                            border-color: #a4262c;
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                        }

                        .search-bar {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: #f5f5f5;
                            border-radius: 6px;
                            margin: 8px 0;
                            flex-wrap: wrap;
                        }

                        .search-bar input {
                            padding: 6px 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                            min-width: 120px;
                        }

                        .search-bar input:focus {
                            outline: none;
                            border-color: #0078d4;
                            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
                        }

                        .search-bar button {
                            padding: 6px 10px;
                            font-size: 14px;
                            min-height: 28px;
                        }

                        .search-highlight {
                            background-color: #ffff00 !important;
                            color: #000 !important;
                        }

                        .search-current {
                            background-color: #0078d4 !important;
                            color: #fff !important;
                        }
                        
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        
                        @keyframes slideUp {
                            from {
                                opacity: 0;
                                transform: translateY(10px) scale(0.98);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0) scale(1);
                            }
                        }
                        
                        @media (max-width: 600px) {
                            .fluent-dialog {
                                min-width: 280px;
                                margin: 16px;
                            }
                            
                            .fluent-dialog-header {
                                padding: 16px 20px 0;
                            }
                            
                            .fluent-dialog-content {
                                padding: 8px 20px 20px;
                            }
                            
                            .fluent-dialog-footer {
                                padding: 0 20px 16px;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                window.__fluentDialogResolve = resolve;
                document.body.appendChild(dialog);
                
                // 添加遮罩层点击关闭
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.remove();
                        resolve(false);
                    }
                });
                
                // ESC键关闭
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        dialog.remove();
                        resolve(false);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }

        function smartGuessTimeTable() {
            const tbody = document.getElementById('timeTable').querySelector('tbody');
            const rows = Array.from(tbody.children);
            // 找到最后一个已完整填写的节次
            let lastIdx = -1;
            let lastEnd = '';
            let lastRest = '';
            for (let i = 0; i < rows.length; i++) {
                const begin = rows[i].querySelector('.time-begin').value;
                const end = rows[i].querySelector('.time-end').value;
                const restBegin = rows[i].querySelector('.rest-begin').value;
                const restEnd = rows[i].querySelector('.rest-end').value;
                if (begin && end && restBegin && restEnd) {
                    lastIdx = i;
                    lastEnd = end;
                    lastRest = restEnd;
                }
            }
            if (lastIdx === -1 || lastIdx === rows.length - 1) {
                showStatus('请先手动填写前几节课的时间（至少一节），再使用智能推算。', 'error');
                return;
            }
            // 计算课时、休息时长
            function timeStrToMin(t) {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            }
            function minToTimeStr(m) {
                const h = Math.floor(m / 60).toString().padStart(2, '0');
                const mm = (m % 60).toString().padStart(2, '0');
                return `${h}:${mm}`;
            }
            const prevBegin = rows[lastIdx].querySelector('.time-begin').value;
            const prevEnd = rows[lastIdx].querySelector('.time-end').value;
            const prevRestBegin = rows[lastIdx].querySelector('.rest-begin').value;
            const prevRestEnd = rows[lastIdx].querySelector('.rest-end').value;
            const classLen = timeStrToMin(prevEnd) - timeStrToMin(prevBegin);
            let restLen = timeStrToMin(prevRestEnd) - timeStrToMin(prevEnd);
            if (restLen <= 0) restLen = 10; // 默认10分钟
            // 补全后续节次
            let curTime = timeStrToMin(prevRestEnd);
            for (let i = lastIdx + 1; i < rows.length; i++) {
                // 上课时间
                const begin = minToTimeStr(curTime);
                // 下课时间
                const end = minToTimeStr(curTime + classLen);
                // 休息时间
                let nextRestLen = restLen;
                // 若上一节休息大于30分钟，推断为午休/晚休，后续休息恢复为10分钟
                if (restLen >= 30) nextRestLen = 10;
                const restBegin = end;
                const restEnd = minToTimeStr(timeStrToMin(end) + nextRestLen);
                // 填入表格
                rows[i].querySelector('.time-begin').value = begin;
                rows[i].querySelector('.time-end').value = end;
                rows[i].querySelector('.rest-begin').value = restBegin;
                rows[i].querySelector('.rest-end').value = restEnd;
                // 更新推算基准
                curTime = timeStrToMin(restEnd);
                restLen = nextRestLen;
            }
            showStatus('已根据已填时间智能补全后续节次，请根据实际情况微调。', 'success');
        }


        async function openInBrowser() {
            const url = document.getElementById('url').value.trim();
            if (!url) {
                showStatus('请先输入有效的URL', 'error');
                return;
            }

            try {
                await waitForBinding('openURLInBrowser');
                const result = await window.openURLInBrowser(url);
                showStatus(result ? '已在浏览器中打开页面' : '打开浏览器失败',
                    result ? 'success' : 'error');
            } catch (e) {
                console.error('打开浏览器失败:', e);
                showStatus('打开浏览器失败: ' + e.message, 'error');
            }
        }

        // 页面加载时读取配置
        document.addEventListener('DOMContentLoaded', handleReset);
        
        // 全局点击事件，确保点击其他地方时完成编辑
        document.addEventListener('click', (e) => {
            if (window.tableEditor && tableEditor.editingCell) {
                const editingCell = tableEditor.editingCell;
                const clickedInsideCell = e.target === editingCell || editingCell.contains(e.target);
                if (!clickedInsideCell && !e.target.classList.contains('edit-input')) {
                    tableEditor.finishEditing();
                }
            }
        });

        // Office风格表格编辑功能
        class OfficeTableEditor {
            constructor(tableId) {
                this.table = document.getElementById(tableId);
                this.selectedCells = [];
                this.copiedData = [];
                this.history = [];
                this.historyIndex = 0;
                this.isSelecting = false;
                this.startCell = null;
                this.editingCell = null;
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupTouchSupport();
                this.createContextMenu();
            }

            setupEventListeners() {
                // 鼠标事件
                this.table.addEventListener('click', (e) => this.handleCellClick(e));
                this.table.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.table.addEventListener('mouseover', (e) => this.handleMouseOver(e));
                this.table.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                this.table.addEventListener('dblclick', (e) => {
                    const cell = this.getCellFromEvent(e);
                    if (cell && cell.tagName !== 'TH' && !cell.classList.contains('schedule-day')) {
                        this.startEditing(cell);
                    }
                });
                
                // 键盘事件
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                
                // 右键菜单
                this.table.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
            }

            setupTouchSupport() {
                let touchTimer = null;
                let touchStartTime = 0;
                let touchStartPos = { x: 0, y: 0 };

                this.table.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStartPos = { x: touch.clientX, y: touch.clientY };
                    touchStartTime = Date.now();
                    
                    // 长按检测
                    touchTimer = setTimeout(() => {
                        const cell = this.getCellFromEvent(e);
                        if (cell) {
                            this.showLongPressMenu(e, cell);
                        }
                    }, 500);
                });

                this.table.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const distance = Math.sqrt(
                        Math.pow(touch.clientX - touchStartPos.x, 2) + 
                        Math.pow(touch.clientY - touchStartPos.y, 2)
                    );
                    
                    if (distance > 10) {
                        clearTimeout(touchTimer);
                    }
                });

                this.table.addEventListener('touchend', (e) => {
                    clearTimeout(touchTimer);
                    
                    const touchDuration = Date.now() - touchStartTime;
                    if (touchDuration < 500) {
                        const cell = this.getCellFromEvent(e);
                        if (cell) {
                            this.handleCellClick(e);
                        }
                    }
                });
            }

            getCellFromEvent(e) {
                const target = e.target;
                if (target.tagName === 'TD' || target.tagName === 'TH') {
                    return target;
                }
                return target.closest('td') || target.closest('th');
            }

            handleCellClick(e) {
                const cell = this.getCellFromEvent(e);
                if (!cell || cell.tagName === 'TH') return;

                if (e.ctrlKey || e.metaKey) {
                    this.toggleCellSelection(cell);
                } else {
                    this.selectCell(cell);
                }
            }

            handleMouseDown(e) {
                const cell = this.getCellFromEvent(e);
                if (!cell || cell.tagName === 'TH') return;

                this.isSelecting = true;
                this.startCell = cell;
                this.selectCell(cell);
                e.preventDefault();
            }

            handleMouseOver(e) {
                if (!this.isSelecting) return;
                
                const cell = this.getCellFromEvent(e);
                if (!cell || cell.tagName === 'TH') return;

                this.selectRange(this.startCell, cell);
            }

            handleMouseUp() {
                this.isSelecting = false;
            }

            handleKeyDown(e) {
                // 如果正在编辑，不处理键盘事件
                if (this.editingCell) return;
                
                if (this.selectedCells.length === 0) return;

                switch(e.key) {
                    case 'Delete':
                        this.clearCells();
                        e.preventDefault();
                        break;
                    case 'c':
                        if (e.ctrlKey || e.metaKey) {
                            this.copyCells();
                            e.preventDefault();
                        }
                        break;
                    case 'v':
                        if (e.ctrlKey || e.metaKey) {
                            this.pasteCells();
                            e.preventDefault();
                        }
                        break;
                    case 'z':
                        if (e.ctrlKey || e.metaKey) {
                            if (e.shiftKey) {
                                this.redoAction();
                            } else {
                                this.undoAction();
                            }
                            e.preventDefault();
                        }
                        break;
                    case 'Enter':
                        this.startEditing(this.selectedCells[0]);
                        e.preventDefault();
                        break;
                }
            }

            handleContextMenu(e) {
                e.preventDefault();
                const cell = this.getCellFromEvent(e);
                if (cell && cell.tagName !== 'TH') {
                    // 如果右键点击的单元格不在当前选中的单元格中，则重新选择该单元格
                    if (!this.selectedCells.includes(cell)) {
                        this.selectCell(cell);
                    }
                    this.showContextMenu(e, cell);
                }
            }

            selectCell(cell) {
                this.clearSelection();
                this.selectedCells = [cell];
                cell.classList.add('selected');
            }

            toggleCellSelection(cell) {
                const index = this.selectedCells.indexOf(cell);
                if (index > -1) {
                    this.selectedCells.splice(index, 1);
                    cell.classList.remove('selected');
                } else {
                    this.selectedCells.push(cell);
                    cell.classList.add('selected');
                }
            }

            selectRange(startCell, endCell) {
                this.clearSelection();
                
                const startRow = startCell.parentElement.rowIndex;
                const startCol = startCell.cellIndex;
                const endRow = endCell.parentElement.rowIndex;
                const endCol = endCell.cellIndex;
                
                const minRow = Math.min(startRow, endRow);
                const maxRow = Math.max(startRow, endRow);
                const minCol = Math.min(startCol, endCol);
                const maxCol = Math.max(startCol, endCol);

                this.selectedCells = [];
                for (let row = minRow; row <= maxRow; row++) {
                    for (let col = minCol; col <= maxCol; col++) {
                        const cell = this.table.rows[row].cells[col];
                        if (cell && cell.tagName !== 'TH') {
                            cell.classList.add('selected');
                            this.selectedCells.push(cell);
                        }
                    }
                }
            }

            clearSelection() {
                this.selectedCells.forEach(cell => cell.classList.remove('selected'));
                this.selectedCells = [];
            }

            startEditing(cell) {
                if (!cell || cell.tagName === 'TH' || cell.classList.contains('schedule-day')) return;
                
                // 如果已经在编辑，先完成当前编辑
                if (this.editingCell && this.editingCell !== cell) {
                    this.finishEditing();
                }
                
                this.editingCell = cell;
                cell.classList.add('editing');
                
                const originalValue = cell.textContent.trim();
                cell.dataset.originalValue = originalValue;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = originalValue;
                input.className = 'edit-input';
                input.style.cssText = `
                    width: 100% !important;
                    height: 100% !important;
                    border: 2px solid var(--primary-color) !important;
                    background: var(--card-bg) !important;
                    color: var(--text-color) !important;
                    font-size: inherit !important;
                    font-family: inherit !important;
                    text-align: center !important;
                    padding: 8px !important;
                    margin: 0 !important;
                    outline: none !important;
                    box-sizing: border-box !important;
                    border-radius: 4px !important;
                    z-index: 1000 !important;
                    position: relative !important;
                `;
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();

                const finishEditing = () => {
                    if (!this.editingCell || this.editingCell !== cell) return;
                    
                    const newValue = input.value.trim();
                    if (newValue !== originalValue) {
                        this.saveState();
                        cell.textContent = newValue;
                    } else {
                        cell.textContent = originalValue;
                    }
                    cell.classList.remove('editing');
                    delete cell.dataset.originalValue;
                    this.editingCell = null;
                };

                input.addEventListener('blur', finishEditing);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        finishEditing();
                        e.preventDefault();
                        e.stopPropagation();
                    } else if (e.key === 'Escape') {
                        cell.textContent = originalValue;
                        cell.classList.remove('editing');
                        delete cell.dataset.originalValue;
                        this.editingCell = null;
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });

                // 防止事件冒泡
                input.addEventListener('mousedown', (e) => e.stopPropagation());
                input.addEventListener('click', (e) => e.stopPropagation());
                input.addEventListener('dblclick', (e) => e.stopPropagation());
            }
            
            finishEditing() {
                if (!this.editingCell) return;
                
                const cell = this.editingCell;
                const input = cell.querySelector('.edit-input');
                if (input) {
                    const originalValue = cell.dataset.originalValue || '';
                    const newValue = input.value.trim();
                    
                    if (newValue !== originalValue) {
                        this.saveState();
                        cell.textContent = newValue;
                    } else {
                        cell.textContent = originalValue;
                    }
                }
                
                cell.classList.remove('editing');
                delete cell.dataset.originalValue;
                this.editingCell = null;
            }

            addRow() {
                this.saveState();
                const tbody = this.table.querySelector('tbody');
                const newRow = tbody.insertRow();
                const headerCells = this.table.querySelector('thead tr').cells;
                
                for (let i = 0; i < headerCells.length; i++) {
                    const cell = newRow.insertCell();
                    if (i === 0) {
                        cell.textContent = '新行';
                        cell.style.fontWeight = 'bold';
                    } else {
                        cell.textContent = '';
                        cell.classList.add('schedule-cell');
                    }
                }
            }

            addColumn() {
                this.saveState();
                const headerRow = this.table.querySelector('thead tr');
                const newHeader = headerRow.insertCell();
                newHeader.textContent = '新列';
                
                const rows = this.table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const newCell = row.insertCell();
                    newCell.textContent = '';
                    newCell.classList.add('schedule-cell');
                });
            }


            deleteSelected() {
                if (this.selectedCells.length === 0) return;
                
                this.saveState();
                this.selectedCells.forEach(cell => {
                    cell.textContent = '';
                });
            }

            clearCells() {
                if (this.selectedCells.length === 0) return;
                
                this.saveState();
                this.selectedCells.forEach(cell => {
                    cell.textContent = '';
                });
            }

            copyCells() {
                if (this.selectedCells.length === 0) return;
                
                this.copiedData = this.selectedCells.map(cell => cell.textContent);
            }

            pasteCells() {
                if (this.copiedData.length === 0 || this.selectedCells.length === 0) return;
                
                this.saveState();
                this.selectedCells.forEach((cell, index) => {
                    cell.textContent = this.copiedData[index % this.copiedData.length];
                });
            }

            mergeCells() {
                if (this.selectedCells.length < 2) {
                    showStatus('请选择至少两个单元格进行合并', 'error');
                    return;
                }

                this.saveState();

                try {
                    const tbody = this.table.querySelector('tbody');
                    const positions = this.selectedCells.map(cell => {
                        const row = cell.parentElement;
                        return {
                            cell,
                            row: Array.from(tbody.children).indexOf(row),
                            col: Array.from(row.children).indexOf(cell)
                        };
                    });

                    const minRow = Math.min(...positions.map(p => p.row));
                    const maxRow = Math.max(...positions.map(p => p.row));
                    const minCol = Math.min(...positions.map(p => p.col));
                    const maxCol = Math.max(...positions.map(p => p.col));

                    // 验证矩形区域
                    const expected = (maxRow - minRow + 1) * (maxCol - minCol + 1);
                    if (expected !== positions.length) {
                        showStatus('请选择连续的矩形区域进行合并', 'error');
                        return;
                    }

                    const firstCell = tbody.children[minRow].cells[minCol];
                    
                    // 收集完整的原始内容矩阵
                    const originalData = {
                        content: []
                    };

                    // 保存内容矩阵
                    for (let r = minRow; r <= maxRow; r++) {
                        originalData.content[r - minRow] = [];
                        for (let c = minCol; c <= maxCol; c++) {
                            originalData.content[r - minRow][c - minCol] = tbody.children[r].cells[c].textContent;
                        }
                    }

                    // 合并内容（行列用换行分隔，行内用空格分隔）
                    firstCell.textContent = originalData.content.map(row => row.join(' ')).join('\n');
                    firstCell.setAttribute('data-merged-content', JSON.stringify(originalData));

                    // 清空其他单元格
                    positions.forEach(pos => {
                        if (pos.cell !== firstCell) pos.cell.textContent = '';
                    });

                    showStatus(`合并 ${maxRow-minRow+1}行 × ${maxCol-minCol+1}列`, 'success');
                } catch (e) {
                    showStatus('合并失败: ' + e.message, 'error');
                }
            }

            splitCell() {
                if (this.selectedCells.length < 1) {
                    showStatus('请至少选择一个单元格进行拆分', 'error');
                    return;
                }

                this.saveState();

                try {
                    const tbody = this.table.querySelector('tbody');
                    
                    // 获取选定区域的边界
                    const positions = this.selectedCells.map(cell => {
                        const row = cell.parentElement;
                        return {
                            cell,
                            row: Array.from(tbody.children).indexOf(row),
                            col: Array.from(row.children).indexOf(cell)
                        };
                    });

                    const minRow = Math.min(...positions.map(p => p.row));
                    const maxRow = Math.max(...positions.map(p => p.row));
                    const minCol = Math.min(...positions.map(p => p.col));
                    const maxCol = Math.max(...positions.map(p => p.col));

                    const selectionHeight = maxRow - minRow + 1;
                    const selectionWidth = maxCol - minCol + 1;

                    // 使用第一个单元格的内容作为拆分源
                    const firstCell = this.selectedCells[0];
                    const text = firstCell.textContent.trim();
                    
                    if (!text) {
                        showStatus('单元格内容为空，无法拆分', 'error');
                        return;
                    }

                    // 智能检测文本结构并解析为矩阵
                    let matrix = [];
                    
                    // 首先检查是否是合并单元格的还原
                    const mergedData = firstCell.getAttribute('data-merged-content');
                    if (mergedData) {
                        // 合并单元格还原 - 使用原始数据结构
                        const originalData = JSON.parse(mergedData);
                        matrix = originalData.content;
                    } else {
                        // 普通文本拆分 - 智能解析行列结构
                        
                        // 1. 按行分割
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            showStatus('无法解析文本结构', 'error');
                            return;
                        }

                        // 2. 智能检测列分隔符
                        let delimiter = null;
                        
                        // 检测制表符
                        if (text.includes('\t')) {
                            delimiter = '\t';
                        }
                        // 检测竖线表格
                        else if (lines.some(line => line.includes('|') && line.split('|').length > 2)) {
                            delimiter = '|';
                        }
                        // 检测逗号分隔
                        else if (lines.some(line => line.includes(',') && line.split(',').length > 1)) {
                            delimiter = ',';
                        }
                        // 默认使用空格
                        else {
                            delimiter = /\s+/;
                        }

                        // 3. 解析每行的列数据
                        matrix = lines.map(line => {
                            let parts;
                            
                            if (delimiter === '|') {
                                // 处理竖线表格，去除边框字符
                                parts = line.split('|')
                                    .map(part => part.trim())
                                    .filter(part => part && part !== '-' && part !== '');
                            } else {
                                parts = line.split(delimiter).map(part => part.trim());
                            }
                            
                            return parts.filter(part => part || parts.length > 1);
                        });

                        // 4. 标准化矩阵（确保每行列数一致）
                        const maxCols = Math.max(...matrix.map(row => row.length), 1);
                        matrix = matrix.map(row => {
                            const normalized = [...row];
                            while (normalized.length < maxCols) {
                                normalized.push('');
                            }
                            return normalized.slice(0, maxCols);
                        });
                    }

                    if (matrix.length === 0 || matrix[0].length === 0) {
                        showStatus('无法解析文本结构', 'error');
                        return;
                    }

                    const contentRows = matrix.length;
                    const contentCols = matrix[0].length;

                    // 在选定区域内填充，超出部分截断
                    const actualRows = Math.min(contentRows, selectionHeight);
                    const actualCols = Math.min(contentCols, selectionWidth);

                    // 在选定区域内填充内容
                    for (let r = 0; r < actualRows; r++) {
                        for (let c = 0; c < actualCols; c++) {
                            const targetRow = minRow + r;
                            const targetCol = minCol + c;
                            
                            if (tbody.children[targetRow] && tbody.children[targetRow].cells[targetCol]) {
                                tbody.children[targetRow].cells[targetCol].textContent = matrix[r][c] || '';
                            }
                        }
                    }

                    // 清理合并标记
                    if (firstCell.getAttribute('data-merged-content')) {
                        firstCell.removeAttribute('data-merged-content');
                        firstCell.removeAttribute('data-merged-info');
                    }

                    // 智能提示信息
                    let delimiterInfo = '';
                    if (!mergedData) {
                        if (text.includes('\t')) delimiterInfo = '（制表符分隔）';
                        else if (text.includes('|')) delimiterInfo = '（竖线分隔）';
                        else if (text.includes(',')) delimiterInfo = '（逗号分隔）';
                        else delimiterInfo = '（空格分隔）';
                    }

                    showStatus(`已在选定区域内拆分 ${actualRows}行 × ${actualCols}列 ${delimiterInfo}`, 'success');
                    
                } catch (e) {
                    showStatus('拆分失败: ' + e.message, 'error');
                }
            }

        

            // 新增：批量填充序列
            fillSeries() {
                if (this.selectedCells.length < 2) {
                    showStatus('请至少选择2个单元格来填充序列', 'error');
                    return;
                }
                
                // 保存当前选中状态用于撤销
                this.saveState();
                
                const values = this.selectedCells.map(cell => {
                    const text = cell.textContent.trim();
                    const num = parseFloat(text);
                    return isNaN(num) ? text : num; // 保留原始文本用于非数字序列
                });
                
                // 检测序列类型
                let isNumeric = values.every(v => !isNaN(parseFloat(v)));
                
                if (isNumeric) {
                    // 数字序列
                    const numValues = values.map(v => parseFloat(v));
                    let step = 1;
                    if (numValues.length >= 2) {
                        step = numValues[1] - numValues[0];
                    }
                    
                    let currentValue = numValues[0];
                    this.selectedCells.forEach((cell, index) => {
                        if (index === 0) return;
                        currentValue += step;
                        cell.textContent = currentValue.toString();
                    });
                } else {
                    // 文本序列：检测是否有数字后缀
                    const patterns = values.map(v => {
                        const match = v.toString().match(/^(.*?)(\d+)$/);
                        if (match) {
                            return { prefix: match[1], number: parseInt(match[2]) };
                        }
                        return null;
                    });
                    
                    if (patterns.every(p => p !== null)) {
                        // 有数字后缀的文本序列
                        let step = 1;
                        if (patterns.length >= 2) {
                            step = patterns[1].number - patterns[0].number;
                        }
                        
                        let currentNumber = patterns[0].number;
                        const prefix = patterns[0].prefix;
                        
                        this.selectedCells.forEach((cell, index) => {
                            if (index === 0) return;
                            currentNumber += step;
                            cell.textContent = prefix + currentNumber;
                        });
                    } else {
                        // 简单复制第一个值
                        const firstValue = values[0];
                        this.selectedCells.forEach((cell, index) => {
                            if (index === 0) return;
                            cell.textContent = firstValue;
                        });
                    }
                }
                
                showStatus('序列填充完成', 'success');
            }

            // 新增：查找和替换
            findAndReplace() {
                this.showFindReplaceDialog();
            }

            // 新增：获取撤销/重做状态
            getUndoRedoStatus() {
                return {
                    canUndo: this.historyIndex > 0,
                    canRedo: this.historyIndex < this.history.length - 1,
                    undoCount: this.historyIndex,
                    redoCount: this.history.length - 1 - this.historyIndex,
                    maxHistory: 50,
                    currentIndex: this.historyIndex,
                    totalStates: this.history.length,
                    isEmpty: this.history.length === 0
                }
            }

            // 清空单元格内容
            clearCells() {
                if (this.selectedCells.length === 0) {
                    showStatus('请先选择要清空的单元格', 'error');
                    return;
                }

                this.saveState();

                this.selectedCells.forEach(cell => {
                    // 清空内容
                    cell.textContent = '';
                    
                    // 清除合并相关的样式和属性
                    cell.style.backgroundColor = '';
                    cell.style.border = '';
                    cell.removeAttribute('data-merged-content');
                    cell.removeAttribute('data-original-contents');
                    cell.removeAttribute('data-merged-cells');
                    cell.removeAttribute('data-merged-empty');
                    cell.removeAttribute('data-main-cell-row');
                    cell.removeAttribute('data-main-cell-col');
                });

                showStatus(`已清空 ${this.selectedCells.length} 个单元格`, 'success');
            }

            // 清除历史记录
            clearHistory() {
                const status = this.getUndoRedoStatus();
                if (status.totalStates > 1) {
                    this.showFluentDialog({
                        title: '清除历史记录',
                        message: `确定要清除所有撤销/重做历史记录吗？这将无法恢复。当前有 ${status.totalStates} 个历史状态。`,
                        type: 'warning',
                        confirmText: '确定清除',
                        cancelText: '取消'
                    }).then(result => {
                        if (result) {
                            this.history = [this.history[this.historyIndex]];
                            this.historyIndex = 0;
                            showStatus('历史记录已清除', 'success');
                            if (typeof updateUndoRedoButtons === 'function') {
                                updateUndoRedoButtons();
                            }
                        }
                    });
                } else {
                    showStatus('当前没有历史记录可清除', 'info');
                }
            }

            showFindReplaceDialog() {
                // 创建查找替换对话框
                const dialog = document.createElement('div');
                dialog.id = 'findReplaceDialog';
                dialog.className = 'find-replace-dialog';
                dialog.innerHTML = `
                    <div class="find-replace-container">
                        <div class="dialog-header">
                            <h3>查找和替换</h3>
                            <button class="close-btn" onclick="this.closest('.find-replace-dialog').remove()">&times;</button>
                        </div>
                        <div class="dialog-content">
                            <div class="form-group">
                                <label for="findText">查找内容：</label>
                                <input type="text" id="findText" placeholder="输入要查找的文本" class="form-input">
                                <div class="find-options">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="matchCase"> 区分大小写
                                    </label>
                                        <label class="checkbox-label">
                                        <input type="checkbox" id="wholeWord"> 全词匹配
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="replaceText">替换为：</label>
                                <input type="text" id="replaceText" placeholder="输入替换文本" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>查找范围：</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="searchScope" value="all" checked> 整个表格
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="searchScope" value="selected"> 选定单元格
                                    </label>
                                </div>
                            </div>
                            <div class="dialog-buttons">
                                <button class="btn btn-secondary" onclick="this.closest('.find-replace-dialog').remove()">取消</button>
                                <button class="btn btn-primary" id="findBtn">查找</button>
                                <button class="btn btn-primary" id="replaceBtn">替换</button>
                                <button class="btn btn-primary" id="replaceAllBtn">全部替换</button>
                            </div>
                        </div>
                        <div class="find-results" id="findResults" style="display: none;">
                            <div class="results-header">查找结果</div>
                            <div class="results-content" id="resultsContent"></div>
                        </div>
                    </div>
                `;

                // 添加样式
                if (!document.querySelector('#find-replace-styles')) {
                    const style = document.createElement('style');
                    style.id = 'find-replace-styles';
                    style.textContent = `
                        .find-replace-dialog {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            backdrop-filter: blur(4px);
                        }

                        .find-replace-container {
                            background: var(--card-bg);
                            border-radius: 8px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                            min-width: 400px;
                            max-width: 500px;
                            max-height: 90vh;
                            overflow-y: auto;
                            border: 1px solid var(--border-color);
                        }

                        .dialog-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 16px 20px;
                            border-bottom: 1px solid var(--border-color);
                        }

                        .dialog-header h3 {
                            margin: 0;
                            font-size: 18px;
                            color: var(--text-color);
                        }

                        .close-btn {
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: var(--text-color-secondary);
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 4px;
                            transition: all 0.2s;
                        }

                        .close-btn:hover {
                            background: var(--hover-color);
                            color: var(--text-color);
                        }

                        .dialog-content {
                            padding: 20px;
                        }

                        .form-group {
                            margin-bottom: 16px;
                        }

                        .form-group label {
                            display: block;
                            margin-bottom: 4px;
                            font-weight: 500;
                            color: var(--text-color);
                        }

                        .form-input {
                            width: 100%;
                            padding: 8px 12px;
                            border: 1px solid var(--border-color);
                            border-radius: 4px;
                            background: var(--card-bg);
                            color: var(--text-color);
                            font-size: 14px;
                        }

                        .form-input:focus {
                            outline: none;
                            border-color: var(--primary-color);
                            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
                        }

                        .find-options {
                            display: flex;
                            gap: 16px;
                            margin-top: 8px;
                        }

                        .checkbox-label, .radio-label {
                            display: flex;
                            align-items: center;
                            gap: 4px;
                            font-size: 14px;
                            cursor: pointer;
                        }

                        .radio-group {
                            display: flex;
                            gap: 16px;
                        }

                        .dialog-buttons {
                            display: flex;
                            gap: 8px;
                            justify-content: flex-end;
                            margin-top: 20px;
                        }

                        .btn {
                            padding: 8px 16px;
                            border: 1px solid transparent;
                            border-radius: 4px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.2s;
                        }

                        .btn-primary {
                            background: var(--primary-color);
                            color: white;
                            border-color: var(--primary-color);
                        }

                        .btn-primary:hover {
                            background: var(--primary-hover);
                        }

                        .btn-secondary {
                            background: var(--secondary-color);
                            color: var(--text-color);
                            border-color: var(--border-color);
                        }

                        .btn-secondary:hover {
                            background: var(--hover-color);
                        }

                        .find-results {
                            border-top: 1px solid var(--border-color);
                            padding: 16px 20px;
                            background: var(--background-color);
                        }

                        .results-header {
                            font-weight: 500;
                            margin-bottom: 8px;
                            color: var(--text-color);
                        }

                        .results-content {
                            font-size: 14px;
                            color: var(--text-color-secondary);
                        }

                        .result-item {
                            padding: 4px 0;
                            cursor: pointer;
                            border-radius: 2px;
                        }

                        .result-item:hover {
                            background: var(--hover-color);
                        }
                    `;
                    document.head.appendChild(style);
                }

                // 添加到页面
                document.body.appendChild(dialog);

                // 绑定事件
                const findText = dialog.querySelector('#findText');
                const replaceText = dialog.querySelector('#replaceText');
                const findBtn = dialog.querySelector('#findBtn');
                const replaceBtn = dialog.querySelector('#replaceBtn');
                const replaceAllBtn = dialog.querySelector('#replaceAllBtn');
                const matchCase = dialog.querySelector('#matchCase');
                const wholeWord = dialog.querySelector('#wholeWord');
                const searchScope = dialog.querySelectorAll('input[name="searchScope"]');

                // 查找功能
                findBtn.addEventListener('click', () => {
                    this.performFind(findText.value, {
                        matchCase: matchCase.checked,
                        wholeWord: wholeWord.checked,
                        scope: Array.from(searchScope).find(r => r.checked).value
                    });
                });

                // 替换功能
                replaceBtn.addEventListener('click', () => {
                    this.performReplace(findText.value, replaceText.value, {
                        matchCase: matchCase.checked,
                        wholeWord: wholeWord.checked,
                        scope: Array.from(searchScope).find(r => r.checked).value,
                        all: false
                    });
                });

                // 全部替换功能
                replaceAllBtn.addEventListener('click', () => {
                    this.performReplace(findText.value, replaceText.value, {
                        matchCase: matchCase.checked,
                        wholeWord: wholeWord.checked,
                        scope: Array.from(searchScope).find(r => r.checked).value,
                        all: true
                    });
                    dialog.remove();
                });

                // 聚焦到查找输入框
                findText.focus();
            }

            performFind(searchTerm, options = {}) {
                if (!searchTerm) return;

                const results = [];
                let targetCells = [];

                // 确定查找范围
                if (options.scope === 'selected' && this.selectedCells.length > 0) {
                    targetCells = this.selectedCells;
                } else {
                    targetCells = Array.from(this.table.querySelectorAll('td'));
                }

                // 执行查找
                targetCells.forEach((cell, index) => {
                    let content = cell.textContent;
                    let searchContent = searchTerm;

                    if (!options.matchCase) {
                        content = content.toLowerCase();
                        searchContent = searchContent.toLowerCase();
                    }

                    let matches = [];
                    if (options.wholeWord) {
                        const words = content.split(/\s+/);
                        words.forEach((word, wordIndex) => {
                            if (word === searchContent) {
                                matches.push({ wordIndex, word });
                            }
                        });
                    } else {
                        let startIndex = 0;
                        let index = content.indexOf(searchContent, startIndex);
                        while (index !== -1) {
                            matches.push({ index, text: searchTerm });
                            startIndex = index + searchContent.length;
                            index = content.indexOf(searchContent, startIndex);
                        }
                    }

                    if (matches.length > 0) {
                        results.push({
                            cell: cell,
                            matches: matches,
                            cellIndex: index
                        });
                    }
                });

                // 显示结果
                this.showFindResults(results, searchTerm);
                return results.length;
            }

            performReplace(searchTerm, replaceTerm, options = {}) {
                if (!searchTerm) return;

                let targetCells = [];
                let replacedCount = 0;

                // 确定替换范围
                if (options.scope === 'selected' && this.selectedCells.length > 0) {
                    targetCells = this.selectedCells;
                } else {
                    targetCells = Array.from(this.table.querySelectorAll('td'));
                }

                this.saveState();

                targetCells.forEach(cell => {
                    let content = cell.textContent;
                    let searchContent = searchTerm;
                    let originalContent = content;

                    if (!options.matchCase) {
                        content = content.toLowerCase();
                        searchContent = searchContent.toLowerCase();
                    }

                    if (options.wholeWord) {
                        const regex = new RegExp(`\\b${this.escapeRegExp(searchTerm)}\\b`, options.matchCase ? 'g' : 'gi');
                        cell.textContent = originalContent.replace(regex, replaceTerm);
                    } else {
                        const regex = new RegExp(this.escapeRegExp(searchTerm), options.matchCase ? 'g' : 'gi');
                        cell.textContent = originalContent.replace(regex, replaceTerm);
                    }

                    if (cell.textContent !== originalContent) {
                        replacedCount++;
                    }
                });

                if (options.all) {
                    showStatus(`已替换 ${replacedCount} 处内容`, 'success');
                } else {
                    showStatus(`已替换当前选中内容`, 'success');
                }
            }

            escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            showFindResults(results, searchTerm) {
                const resultsDiv = document.getElementById('findResults');
                const contentDiv = document.getElementById('resultsContent');
                
                if (results.length === 0) {
                    contentDiv.innerHTML = '未找到匹配内容';
                } else {
                    contentDiv.innerHTML = `找到 ${results.length} 个匹配项`;
                }
                
                resultsDiv.style.display = 'block';
            }

            // 新增：自动调整列宽
            autoFitColumns() {
                const rows = this.table.querySelectorAll('tr');
                const maxWidths = [];
                
                rows.forEach(row => {
                    Array.from(row.children).forEach((cell, index) => {
                        const width = cell.textContent.length * 8 + 16; // 估算宽度
                        maxWidths[index] = Math.max(maxWidths[index] || 0, width);
                    });
                });
                
                rows.forEach(row => {
                    Array.from(row.children).forEach((cell, index) => {
                        if (maxWidths[index]) {
                            cell.style.minWidth = maxWidths[index] + 'px';
                        }
                    });
                });
                
                showStatus('已自动调整列宽', 'success');
            }

            // 新增：导出表格数据
            exportData() {
                const data = [];
                const rows = this.table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const rowData = [];
                    Array.from(row.children).forEach(cell => {
                        if (cell.tagName === 'TD' && !cell.classList.contains('schedule-day')) {
                            // 处理包含逗号、引号或换行符的单元格
                            let content = cell.textContent.trim();
                            if (content.includes(',') || content.includes('"') || content.includes('\n') || content.includes('\r')) {
                                content = '"' + content.replace(/"/g, '""') + '"';
                            }
                            rowData.push(content);
                        }
                    });
                    if (rowData.length > 0) {
                        data.push(rowData);
                    }
                });
                
                const csv = data.map(row => row.join(',')).join('\n');
                // 添加UTF-8 BOM以解决中文乱码问题
                const bom = '\uFEFF';
                const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'schedule.csv';
                link.click();
                
                showStatus('表格数据已导出（UTF-8编码）', 'success');
            }

            // 新增：导入表格数据
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv,.txt';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        let csv = event.target.result;
                        
                        // 移除UTF-8 BOM
                        if (csv.charCodeAt(0) === 0xFEFF) {
                            csv = csv.slice(1);
                        }
                        
                        // 解析CSV，处理引号和转义字符
                        const rows = [];
                        let currentRow = [];
                        let currentCell = '';
                        let inQuotes = false;
                        let i = 0;
                        
                        while (i < csv.length) {
                            const char = csv[i];
                            const nextChar = csv[i + 1];
                            
                            if (inQuotes) {
                                if (char === '"' && nextChar === '"') {
                                    currentCell += '"';
                                    i += 2;
                                } else if (char === '"') {
                                    inQuotes = false;
                                    i++;
                                } else {
                                    currentCell += char;
                                    i++;
                                }
                            } else {
                                if (char === '"') {
                                    inQuotes = true;
                                    i++;
                                } else if (char === ',') {
                                    currentRow.push(currentCell.trim());
                                    currentCell = '';
                                    i++;
                                } else if (char === '\n' || char === '\r') {
                                    if (currentCell || currentRow.length > 0) {
                                        currentRow.push(currentCell.trim());
                                        rows.push(currentRow);
                                        currentRow = [];
                                        currentCell = '';
                                    }
                                    i++;
                                    if (char === '\r' && nextChar === '\n') i++;
                                } else {
                                    currentCell += char;
                                    i++;
                                }
                            }
                        }
                        
                        if (currentCell || currentRow.length > 0) {
                            currentRow.push(currentCell.trim());
                            rows.push(currentRow);
                        }
                        
                        if (rows.length === 0) {
                            showStatus('未找到有效数据', 'error');
                            return;
                        }
                        
                        this.saveState();
                        
                        // 清空现有内容
                        const tbody = this.table.querySelector('tbody');
                        tbody.innerHTML = '';
                        
                        // 导入数据
                        rows.forEach((row, rowIndex) => {
                            const newRow = tbody.insertRow();
                            
                            // 添加行标题
                            const headerCell = newRow.insertCell();
                            headerCell.textContent = `第${rowIndex + 1}节`;
                            headerCell.style.fontWeight = 'bold';
                            headerCell.classList.add('schedule-day');
                            
                            // 添加数据单元格
                            row.forEach(cellData => {
                                const cell = newRow.insertCell();
                                cell.textContent = cellData;
                                cell.classList.add('schedule-cell');
                            });
                        });
                        
                        showStatus(`表格数据已导入，共${rows.length}行`, 'success');
                    };
                    reader.readAsText(file, 'utf-8'); // 明确指定UTF-8编码
                };
                
                input.click();
            }

            saveState() {
                this.history = this.history.slice(0, this.historyIndex + 1);
                
                // 保存完整状态，包括表格内容、选中状态、列宽等
                const state = {
                    html: this.table.innerHTML,
                    selectedCells: this.selectedCells.map(cell => {
                        const row = cell.parentElement;
                        const rows = Array.from(this.table.querySelectorAll('tbody tr'));
                        const rowIndex = rows.indexOf(row);
                        const cells = Array.from(row.children);
                        const cellIndex = cells.indexOf(cell);
                        return { rowIndex, cellIndex };
                    }),
                    copiedData: JSON.parse(JSON.stringify(this.copiedData)), // 深拷贝复制数据
                    scrollTop: this.table.parentElement?.scrollTop || 0,
                    scrollLeft: this.table.parentElement?.scrollLeft || 0
                };
                
                this.history.push(state);
                this.historyIndex++;
                
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
                
                // 更新撤销/重做按钮状态
                this.updateUndoRedoButtons();
            }

            undoAction() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.restoreState(this.history[this.historyIndex]);
                    showStatus('撤销操作完成', 'info');
                }
            }

            redoAction() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.restoreState(this.history[this.historyIndex]);
                    showStatus('重做操作完成', 'info');
                }
            }

            restoreState(state) {
                if (!state) return;
                
                try {
                    // 完成当前编辑
                    this.finishEditing();
                    
                    // 恢复表格内容
                    this.table.innerHTML = state.html;
                    
                    // 恢复选中状态
                    this.clearSelection();
                    if (state.selectedCells && state.selectedCells.length > 0) {
                        const rows = this.table.querySelectorAll('tbody tr');
                        state.selectedCells.forEach(sel => {
                            const row = rows[sel.rowIndex];
                            if (row && row.children[sel.cellIndex]) {
                                const cell = row.children[sel.cellIndex];
                                cell.classList.add('selected');
                                this.selectedCells.push(cell);
                            }
                        });
                    }
                    
                    // 恢复复制数据
                    if (state.copiedData) {
                        this.copiedData = JSON.parse(JSON.stringify(state.copiedData)); // 深拷贝
                    }
                    
                    // 恢复滚动位置
                    if (this.table.parentElement) {
                        this.table.parentElement.scrollTop = state.scrollTop || 0;
                        this.table.parentElement.scrollLeft = state.scrollLeft || 0;
                    }
                    
                    // 更新撤销/重做按钮状态
                    this.updateUndoRedoButtons();
                    
                } catch (error) {
                    console.error('恢复状态失败:', error);
                    showStatus('恢复状态失败，请重试', 'error');
                }
            }

            reinitializeTable() {
                // 重新初始化表格，确保所有事件监听器和样式正确
                const cells = this.table.querySelectorAll('td');
                cells.forEach(cell => {
                    if (!cell.classList.contains('schedule-day') && !cell.classList.contains('schedule-cell')) {
                        cell.classList.add('schedule-cell');
                    }
                });
                
                // 确保所有单元格都有适当的样式
                const headers = this.table.querySelectorAll('th');
                headers.forEach(header => {
                    if (!header.classList.contains('schedule-day')) {
                        header.classList.add('schedule-day');
                    }
                });
                
                // 不需要重新绑定事件，事件委托已经处理
                // 只需要确保样式正确
            }

            setupTableEvents() {
                // 重新设置表格事件，确保撤销/重做后的交互正常
                const cells = this.table.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                    cell.addEventListener('mouseover', (e) => this.handleMouseOver(e));
                    cell.addEventListener('mouseup', (e) => this.handleMouseUp(e));
                    cell.addEventListener('dblclick', (e) => {
                        if (cell.tagName !== 'TH' && !cell.classList.contains('schedule-day')) {
                            this.startEditing(cell);
                        }
                    });
                });
            }

            selectRow() {
                if (this.selectedCells.length === 0) return;
                
                const firstCell = this.selectedCells[0];
                const row = firstCell.parentElement;
                const cells = Array.from(row.children).filter(cell => 
                    cell.tagName !== 'TH' && !cell.classList.contains('schedule-day')
                );
                
                this.clearSelection();
                cells.forEach(cell => {
                    cell.classList.add('selected');
                    this.selectedCells.push(cell);
                });
            }

            selectColumn() {
                if (this.selectedCells.length === 0) return;
                
                const firstCell = this.selectedCells[0];
                const columnIndex = Array.from(firstCell.parentElement.children).indexOf(firstCell);
                const rows = this.table.querySelectorAll('tbody tr');
                
                this.clearSelection();
                rows.forEach(row => {
                    const cell = row.children[columnIndex];
                    if (cell && cell.tagName !== 'TH' && !cell.classList.contains('schedule-day')) {
                        cell.classList.add('selected');
                        this.selectedCells.push(cell);
                    }
                });
            }

            showFluentDialog(options) {
                return new Promise((resolve) => {
                    const dialog = document.createElement('div');
                    dialog.className = 'fluent-dialog-overlay';
                    dialog.innerHTML = `
                        <div class="fluent-dialog">
                            <div class="fluent-dialog-header">
                                <div class="fluent-dialog-icon ${options.type || 'info'}">
                                    ${options.type === 'danger' ? '⚠️' : options.type === 'warning' ? '⚠️' : 'ℹ️'}
                                </div>
                                <h3 class="fluent-dialog-title">${options.title || '确认操作'}</h3>
                                <button class="fluent-dialog-close" onclick="this.closest('.fluent-dialog-overlay').remove()">×</button>
                            </div>
                            <div class="fluent-dialog-content">
                                <p class="fluent-dialog-message">${options.message || '确定要继续吗？'}</p>
                            </div>
                            <div class="fluent-dialog-footer">
                                <button class="fluent-button fluent-button-secondary">${options.cancelText || '取消'}</button>
                                <button class="fluent-button ${options.type === 'danger' ? 'fluent-button-danger' : 'fluent-button-primary'}">${options.confirmText || '确定'}</button>
                            </div>
                        </div>
                    `;
                    
                    // 添加样式
                    if (!document.querySelector('#fluent-dialog-styles')) {
                        const style = document.createElement('style');
                        style.id = 'fluent-dialog-styles';
                        style.textContent = `
                            .fluent-dialog-overlay {
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: rgba(0, 0, 0, 0.32);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                z-index: 10000;
                                backdrop-filter: blur(8px);
                                animation: fadeIn 0.15s ease-out;
                            }
                            
                            .fluent-dialog {
                                background: var(--card-bg);
                                border-radius: 12px;
                                box-shadow: 0 32px 64px rgba(0, 0, 0, 0.24), 0 0 0 1px rgba(255, 255, 255, 0.08);
                                min-width: 400px;
                                max-width: 520px;
                                margin: 20px;
                                animation: slideUp 0.2s ease-out;
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                overflow: hidden;
                            }
                            
                            .fluent-dialog-header {
                                display: flex;
                                align-items: center;
                                padding: 20px 24px 0;
                                gap: 12px;
                            }
                            
                            .fluent-dialog-icon {
                                font-size: 20px;
                                width: 24px;
                                height: 24px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                flex-shrink: 0;
                            }
                            
                            .fluent-dialog-title {
                                font-size: 20px;
                                font-weight: 600;
                                margin: 0;
                                color: var(--text-color);
                                flex: 1;
                            }
                            
                            .fluent-dialog-close {
                                background: none;
                                border: none;
                                font-size: 20px;
                                cursor: pointer;
                                color: var(--text-color-secondary);
                                padding: 0;
                                width: 32px;
                                height: 32px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                border-radius: 4px;
                                transition: all 0.15s ease;
                            }
                            
                            .fluent-dialog-close:hover {
                                background: var(--hover-color);
                                color: var(--text-color);
                            }
                            
                            .fluent-dialog-content {
                                padding: 8px 24px 24px;
                            }
                            
                            .fluent-dialog-message {
                                font-size: 15px;
                                color: var(--text-color-secondary);
                                line-height: 1.5;
                                margin: 0;
                            }
                            
                            .fluent-dialog-footer {
                                display: flex;
                                gap: 12px;
                                justify-content: flex-end;
                                padding: 0 24px 20px;
                            }
                            
                            .fluent-button {
                                padding: 8px 16px;
                                border: 1px solid var(--border-color);
                                border-radius: 6px;
                                background: var(--card-bg);
                                color: var(--text-color);
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: all 0.15s ease;
                                font-family: inherit;
                                min-width: 80px;
                                height: 36px;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .fluent-button:hover {
                                background: var(--hover-color);
                                border-color: var(--border-color-hover);
                            }
                            
                            .fluent-button:active {
                                transform: scale(0.98);
                            }
                            
                            .fluent-button-primary {
                                background: var(--primary-color);
                                color: white;
                                border-color: var(--primary-color);
                                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            }
                            
                            .fluent-button-primary:hover {
                                background: var(--secondary-color);
                                border-color: var(--secondary-color);
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                            }
                            
                            .fluent-button-danger {
                                background: var(--danger-color);
                                color: white;
                                border-color: var(--danger-color);
                                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                            }
                            
                            .fluent-button-danger:hover {
                                background: #a4262c;
                                border-color: #a4262c;
                                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                            }
                            
                            @keyframes fadeIn {
                                from { opacity: 0; }
                                to { opacity: 1; }
                            }
                            
                            @keyframes slideUp {
                                from {
                                    opacity: 0;
                                    transform: translateY(10px) scale(0.98);
                                }
                                to {
                                    opacity: 1;
                                    transform: translateY(0) scale(1);
                                }
                            }
                            
                            @media (max-width: 600px) {
                                .fluent-dialog {
                                    min-width: 280px;
                                    margin: 16px;
                                }
                                
                                .fluent-dialog-header {
                                    padding: 16px 20px 0;
                                }
                                
                                .fluent-dialog-content {
                                    padding: 8px 20px 20px;
                                }
                                
                                .fluent-dialog-footer {
                                    padding: 0 20px 16px;
                                }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                    
                    document.body.appendChild(dialog);
                    
                    // 设置事件监听器
                    const cancelBtn = dialog.querySelector('.fluent-button-secondary');
                    const confirmBtn = dialog.querySelector('.fluent-button-primary, .fluent-button-danger');
                    
                    cancelBtn.onclick = () => {
                        dialog.remove();
                        resolve(false);
                    };
                    
                    confirmBtn.onclick = () => {
                        dialog.remove();
                        resolve(true);
                    };
                    
                    // 点击背景关闭
                    dialog.onclick = (e) => {
                        if (e.target === dialog) {
                            dialog.remove();
                            resolve(false);
                        }
                    };
                });
            }

            async deleteRow() {
                if (this.selectedCells.length === 0) {
                    await this.showFluentDialog({
                        title: '提示',
                        message: '请先选择要删除的行',
                        confirmText: '确定',
                        type: 'info'
                    });
                    return;
                }
                
                const rowsToDelete = new Set();
                
                this.selectedCells.forEach(cell => {
                    const row = cell.parentElement;
                    if (row.rowIndex > 0) { // 跳过标题行
                        rowsToDelete.add(row);
                    }
                });
                
                if (rowsToDelete.size === 0) {
                    await this.showFluentDialog({
                        title: '提示',
                        message: '请选择有效的行',
                        confirmText: '确定',
                        type: 'info'
                    });
                    return;
                }
                
                const confirmed = await this.showFluentDialog({
                    title: '确认删除',
                    message: `确定要删除选中的 ${rowsToDelete.size} 行吗？此操作不可撤销。`,
                    confirmText: '删除',
                    cancelText: '取消',
                    type: 'danger'
                });
                
                if (confirmed) {
                    this.saveState();
                    rowsToDelete.forEach(row => row.remove());
                    this.clearSelection();
                }
            }

            async deleteColumn() {
                if (this.selectedCells.length === 0) {
                    await this.showFluentDialog({
                        title: '提示',
                        message: '请先选择要删除的列',
                        confirmText: '确定',
                        type: 'info'
                    });
                    return;
                }
                
                const columnsToDelete = new Set();
                
                this.selectedCells.forEach(cell => {
                    const columnIndex = Array.from(cell.parentElement.children).indexOf(cell);
                    columnsToDelete.add(columnIndex);
                });
                
                const columnCount = this.table.rows[0].cells.length;
                const validColumns = Array.from(columnsToDelete).filter(index => index > 0);
                
                if (validColumns.length === 0) {
                    await this.showFluentDialog({
                        title: '提示',
                        message: '请选择有效的列',
                        confirmText: '确定',
                        type: 'info'
                    });
                    return;
                }
                
                const confirmed = await this.showFluentDialog({
                    title: '确认删除',
                    message: `确定要删除选中的 ${validColumns.length} 列吗？此操作不可撤销。`,
                    confirmText: '删除',
                    cancelText: '取消',
                    type: 'danger'
                });
                
                if (confirmed) {
                    this.saveState();
                    
                    // 从右到左删除列，避免索引问题
                    validColumns.sort((a, b) => b - a);
                    validColumns.forEach(index => {
                        Array.from(this.table.rows).forEach(row => {
                            if (row.cells[index]) {
                                row.deleteCell(index);
                            }
                        });
                    });
                    
                    this.clearSelection();
                }
            }

            createContextMenu() {
                // 精简右键菜单 - Fluent Design 核心功能
                const contextMenu = document.createElement('div');
                contextMenu.id = 'contextMenu';
                contextMenu.className = 'context-menu';
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="tableEditor.copyCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">📋</span>
                        <span>复制</span>
                        <span class="menu-shortcut">Ctrl+C</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.pasteCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">📌</span>
                        <span>粘贴</span>
                        <span class="menu-shortcut">Ctrl+V</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.clearCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">🗑️</span>
                        <span>清空</span>
                        <span class="menu-shortcut">Delete</span>
                    </div>
                    
                    <div class="context-menu-separator"></div>
                    
                    <div class="context-menu-item" onclick="tableEditor.selectRow(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">➡️</span>
                        <span>选择整行</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.selectColumn(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">⬇️</span>
                        <span>选择整列</span>
                    </div>
                `;
                document.body.appendChild(contextMenu);

                // 精简长按菜单（触屏）- Fluent Design 核心功能
                const longPressMenu = document.createElement('div');
                longPressMenu.id = 'longPressMenu';
                longPressMenu.className = 'long-press-menu';
                longPressMenu.innerHTML = `
                    <div class="context-menu-item" onclick="tableEditor.copyCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">📋</span>
                        <span>复制</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.pasteCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">📌</span>
                        <span>粘贴</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.clearCells(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">🗑️</span>
                        <span>清空</span>
                    </div>
                    
                    <div class="context-menu-separator"></div>
                    
                    <div class="context-menu-item" onclick="tableEditor.selectRow(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">➡️</span>
                        <span>选择整行</span>
                    </div>
                    <div class="context-menu-item" onclick="tableEditor.selectColumn(); tableEditor.hideContextMenu();">
                        <span class="menu-icon">⬇️</span>
                        <span>选择整列</span>
                    </div>`;
                document.body.appendChild(longPressMenu);
            }

            showContextMenu(e, cell) {
                const menu = document.getElementById('contextMenu');
                if (!menu) {
                    console.error('Context menu not found');
                    return;
                }
                
                // 先隐藏菜单
                menu.style.display = 'none';
                menu.classList.remove('flipped-x', 'flipped-y', 'show');
                
                // 清除之前的活动状态
                menu.querySelectorAll('.context-menu-item.active').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 更新撤销/重做菜单项状态
                const status = this.getUndoRedoStatus();
                const contextUndo = document.getElementById('contextUndo');
                const contextRedo = document.getElementById('contextRedo');
                const contextClearHistory = document.getElementById('contextClearHistory');
                
                if (contextUndo) {
                    contextUndo.style.opacity = status.canUndo ? '1' : '0.5';
                    contextUndo.style.pointerEvents = status.canUndo ? 'auto' : 'none';
                    contextUndo.title = status.canUndo ? 
                        `撤销 (${status.undoCount}/${status.maxHistory})` : 
                        '无操作可撤销';
                }
                
                if (contextRedo) {
                    contextRedo.style.opacity = status.canRedo ? '1' : '0.5';
                    contextRedo.style.pointerEvents = status.canRedo ? 'auto' : 'none';
                    contextRedo.title = status.canRedo ? 
                        `重做 (${status.redoCount}/${status.maxHistory})` : 
                        '无操作可重做';
                }
                
                if (contextClearHistory) {
                    contextClearHistory.style.opacity = !status.isEmpty ? '1' : '0.5';
                    contextClearHistory.style.pointerEvents = !status.isEmpty ? 'auto' : 'none';
                    contextClearHistory.title = !status.isEmpty ? 
                        `清除所有历史记录 (${status.totalStates} 个状态)` : 
                        '历史记录为空';
                }
                
                // 临时显示以获取尺寸
                menu.style.position = 'fixed';
                menu.style.left = '-9999px';
                menu.style.top = '-9999px';
                menu.style.display = 'block';
                menu.classList.add('show');
                menu.style.visibility = 'hidden';
                
                // 获取实际尺寸
                const menuRect = menu.getBoundingClientRect();
                // console.log('菜单宽度:', menuRect.width);
                // console.log('菜单高度:', menuRect.height);
                
                // 计算位置
                let left = e.clientX;
                let top = e.clientY;
                
                // 边界检测
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // 检测是否需要水平翻转
                if (left + menuRect.width > viewportWidth - 10) {
                    left = left - menuRect.width;
                    menu.classList.add('flipped-x');
                }
                
                // 检测是否需要垂直翻转
                if (top + menuRect.height > viewportHeight - 10) {
                    top = top - menuRect.height;
                    menu.classList.add('flipped-y');
                }
                
                // 确保不超出边界
                left = Math.max(10, Math.min(left, viewportWidth - menuRect.width - 10));
                top = Math.max(10, Math.min(top, viewportHeight - menuRect.height - 10));
                
                // 设置最终位置并显示
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                menu.style.visibility = 'visible';
                
                // 阻止事件冒泡
                e.preventDefault();
                e.stopPropagation();
                
                // 记录右键点击的单元格
                this.lastRightClickedCell = cell;
            }

            // 隐藏上下文菜单
            hideContextMenu() {
                const contextMenu = document.getElementById('contextMenu');
                const longPressMenu = document.getElementById('longPressMenu');
                
                if (contextMenu) {
                    contextMenu.style.display = 'none';
                    contextMenu.classList.remove('show');
                }
                if (longPressMenu) {
                    longPressMenu.style.display = 'none';
                    longPressMenu.classList.remove('show');
                }
                
                // 清除活动状态
                document.querySelectorAll('.context-menu-item.active').forEach(item => {
                    item.classList.remove('active');
                });
            }

           
            showLongPressMenu(e, cell) {
                const menu = document.getElementById('longPressMenu');
                
                // 重置样式类
                menu.classList.remove('flipped-x', 'flipped-y');
                
                // 更新撤销/重做菜单项状态
                const status = this.getUndoRedoStatus();
                const longPressUndo = menu.querySelector('[onclick="tableEditor.undoAction()"]');
                const longPressRedo = menu.querySelector('[onclick="tableEditor.redoAction()"]');
                
                if (longPressUndo) {
                    longPressUndo.style.opacity = status.canUndo ? '1' : '0.5';
                    longPressUndo.style.pointerEvents = status.canUndo ? 'auto' : 'none';
                    longPressUndo.title = status.canUndo ? 
                        `撤销 (${status.undoCount}/${status.maxHistory})` : 
                        '无操作可撤销';
                }
                
                if (longPressRedo) {
                    longPressRedo.style.opacity = status.canRedo ? '1' : '0.5';
                    longPressRedo.style.pointerEvents = status.canRedo ? 'auto' : 'none';
                    longPressRedo.title = status.canRedo ? 
                        `重做 (${status.redoCount}/${status.maxHistory})` : 
                        '无操作可重做';
                }
                
                // 先临时显示以获取实际尺寸
                menu.style.display = 'block';
                menu.style.position = 'fixed';
                menu.style.left = '-9999px';
                menu.style.top = '-9999px';
                
                // 获取实际尺寸
                const menuRect = menu.getBoundingClientRect();
                
                // 计算位置，确保菜单左上角精确对准触摸点
                let left = e.touches[0].clientX;
                let top = e.touches[0].clientY;
                
                // 边界检测
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // 检测是否需要水平翻转
                const needsFlipX = left + menuRect.width > viewportWidth;
                if (needsFlipX) {
                    left = left - menuRect.width;
                    menu.classList.add('flipped-x');
                }
                
                // 检测是否需要垂直翻转
                const needsFlipY = top + menuRect.height > viewportHeight;
                if (needsFlipY) {
                    top = top - menuRect.height;
                    menu.classList.add('flipped-y');
                }
                
                // 确保不超出边界
                left = Math.max(8, Math.min(left, viewportWidth - menuRect.width - 8));
                top = Math.max(8, Math.min(top, viewportHeight - menuRect.height - 8));
                
                // 设置最终位置并显示
                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                
                // 阻止事件冒泡
                e.preventDefault();
                e.stopPropagation();
                
                // 移除旧的关闭监听器，让setupMenuEvents中的全局监听器处理
            }

            updateUndoRedoButtons() {
                // 更新撤销/重做按钮状态
                const undoBtn = document.querySelector('[onclick*="undoAction"]');
                const redoBtn = document.querySelector('[onclick*="redoAction"]');
                
                if (undoBtn) {
                    undoBtn.disabled = this.historyIndex <= 0;
                }
                if (redoBtn) {
                    redoBtn.disabled = this.historyIndex >= this.history.length - 1;
                }
                
                // 也更新全局的撤销/重做按钮
                if (typeof updateUndoRedoButtons === 'function') {
                    updateUndoRedoButtons();
                }
            }

            // Excel风格的搜索功能
            searchText(searchTerm, direction = 'down') {
                if (!searchTerm) {
                    this.clearSearchHighlights();
                    return;
                }

                const allCells = Array.from(this.table.querySelectorAll('td'));
                if (allCells.length === 0) return;

                // 清除之前的高亮
                this.clearSearchHighlights();

                // 查找所有匹配的单元格
                const matches = [];
                allCells.forEach((cell, index) => {
                    const text = cell.textContent.toLowerCase();
                    if (text.includes(searchTerm.toLowerCase())) {
                        matches.push({
                            cell: cell,
                            index: index,
                            text: cell.textContent
                        });
                        cell.classList.add('search-highlight');
                    }
                });

                if (matches.length === 0) {
                    this.showFluentDialog({
                        title: '查找',
                        message: `未找到包含 "${searchTerm}" 的内容`,
                        confirmText: '确定',
                        type: 'info'
                    });
                    return;
                }

                // 确定当前选中的单元格
                let currentIndex = 0;
                if (this.selectedCells.length > 0) {
                    const currentCell = this.selectedCells[0];
                    const currentCellIndex = allCells.indexOf(currentCell);
                    if (currentCellIndex !== -1) {
                        // 找到下一个匹配项
                        for (let i = 0; i < matches.length; i++) {
                            if (direction === 'down') {
                                if (matches[i].index > currentCellIndex) {
                                    currentIndex = i;
                                    break;
                                }
                                if (i === matches.length - 1) {
                                    currentIndex = 0; // 循环到第一个
                                }
                            } else {
                                if (matches[i].index < currentCellIndex) {
                                    currentIndex = i;
                                } else {
                                    if (currentIndex === 0 && matches[i].index > currentCellIndex) {
                                        currentIndex = matches.length - 1; // 循环到最后一个
                                    }
                                    break;
                                }
                            }
                        }
                    }
                }

                // 高亮当前匹配项
                const currentMatch = matches[currentIndex];
                currentMatch.cell.classList.add('search-current');
                
                // 滚动到当前匹配项并选中
                currentMatch.cell.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                this.clearSelection();
                this.selectCell(currentMatch.cell);
                
                // 返回匹配结果信息
                return {
                    total: matches.length,
                    current: currentIndex + 1,
                    matches: matches,
                    currentMatch: currentMatch
                };
            }

            // 查找下一个
            searchNext(searchTerm) {
                return this.searchText(searchTerm, 'down');
            }

            // 查找上一个
            searchPrevious(searchTerm) {
                return this.searchText(searchTerm, 'up');
            }

            // 替换文本
            replaceText(searchTerm, replaceTerm, replaceAll = false) {
                if (!searchTerm) return;

                const allCells = Array.from(this.table.querySelectorAll('td'));
                if (allCells.length === 0) return;

                let replacedCount = 0;
                const cellsToReplace = [];

                if (replaceAll) {
                    // 替换所有匹配项
                    allCells.forEach(cell => {
                        if (cell.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                            cellsToReplace.push(cell);
                        }
                    });
                } else {
                    // 只替换当前选中的匹配项
                    const currentCell = this.selectedCells.length > 0 ? this.selectedCells[0] : null;
                    if (currentCell && currentCell.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                        cellsToReplace.push(currentCell);
                    }
                }

                if (cellsToReplace.length > 0) {
                    this.saveState();
                    cellsToReplace.forEach(cell => {
                        cell.textContent = cell.textContent.replace(
                            new RegExp(escapeRegExp(searchTerm), 'gi'), 
                            replaceTerm
                        );
                        replacedCount++;
                    });
                    
                    this.clearSearchHighlights();
                    
                    this.showFluentDialog({
                        title: '替换完成',
                        message: `已替换 ${replacedCount} 个匹配项`,
                        confirmText: '确定',
                        type: 'success'
                    });
                } else {
                    this.showFluentDialog({
                        title: '替换',
                        message: `未找到包含 "${searchTerm}" 的内容`,
                        confirmText: '确定',
                        type: 'info'
                    });
                }

                return replacedCount;
            }

            // 清除搜索高亮
            clearSearchHighlights() {
                this.table.querySelectorAll('.search-highlight, .search-current').forEach(cell => {
                    cell.classList.remove('search-highlight', 'search-current');
                });
            }

            // 选中单元格
            selectCell(cell) {
                this.clearSelection();
                cell.classList.add('selected');
                this.selectedCells = [cell];
                this.lastSelectedCell = cell;
            }
        }

        // 正则表达式转义函数
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            // 处理搜索键盘事件
            function handleSearchKeydown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    findNext();
                } else if (event.key === 'Enter' && event.shiftKey) {
                    event.preventDefault();
                    findPrevious();
                }
            }

            // 查找下一个
            function findNext() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value.trim()) {
                    performSearch('down');
                }
            }

            // 查找上一个
            function findPrevious() {
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value.trim()) {
                    performSearch('up');
                }
            }

            // 替换当前
            function replaceCurrent() {
                performReplace();
            }

            // 替换所有
            function replaceAll() {
                performReplaceAll();
            }

            // 切换搜索栏显示/隐藏
            function toggleSearchBar() {
                const searchBar = document.getElementById('searchBar');
                const searchInput = document.getElementById('searchInput');
                
                if (!searchBar) {
                    console.error('Search bar not found');
                    return;
                }
                
                if (searchBar.style.display === 'none' || searchBar.style.display === '') {
                    searchBar.style.display = 'flex';
                    if (searchInput) searchInput.focus();
                } else {
                    searchBar.style.display = 'none';
                    if (tableEditor) {
                        tableEditor.clearSearchHighlights();
                    }
                }
            }

            // Fluent Design状态提示系统
            function showStatus(message, type = 'info', duration = 3000) {
                // 移除已存在的提示
                const existingStatus = document.querySelector('.status');
                if (existingStatus) {
                    existingStatus.remove();
                }

                const status = document.createElement('div');
                status.className = `status ${type}`;
                status.textContent = message;
                status.style.cssText = `
                    position: fixed;
                    top: 24px;
                    right: 24px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    color: #ffffff;
                    background: rgba(0, 120, 212, 0.9);
                    backdrop-filter: blur(20px) saturate(180%);
                    -webkit-backdrop-filter: blur(20px) saturate(180%);
                    box-shadow: 0 6.4px 14.4px 0 rgba(0, 0, 0, 0.132), 0 1.2px 3.6px 0 rgba(0, 0, 0, 0.108);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    z-index: 1000;
                    animation: fluentSlideIn 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
                    max-width: 300px;
                    word-wrap: break-word;
                `;

                // 添加动画样式
                if (!document.querySelector('#fluentAnimations')) {
                    const style = document.createElement('style');
                    style.id = 'fluentAnimations';
                    style.textContent = `
                        @keyframes fluentSlideIn {
                            from { opacity: 0; transform: translateX(100px) scale(0.9); }
                            to { opacity: 1; transform: translateX(0) scale(1); }
                        }
                        @keyframes fluentSlideOut {
                            from { opacity: 1; transform: translateX(0) scale(1); }
                            to { opacity: 0; transform: translateX(100px) scale(0.9); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(status);

                // 自动消失
                setTimeout(() => {
                    status.style.animation = 'fluentSlideOut 0.2s ease-out';
                    setTimeout(() => status.remove(), 200);
                }, duration);
            }

            // 执行查找
            function performSearch(direction = 'down') {
                if (!tableEditor) return;
                
                const searchInput = document.getElementById('searchInput');
                const searchTerm = searchInput.value.trim();
                
                if (!searchTerm) {
                    tableEditor.clearSearchHighlights();
                    return;
                }

                const result = direction === 'down' ? 
                    tableEditor.searchNext(searchTerm) : 
                    tableEditor.searchPrevious(searchTerm);
                
                if (result) {
                    if (result.total === 0) {
                        showStatus(`未找到 "${searchTerm}"`, 'error', 2000);
                    } else {
                        showStatus(`找到 ${result.total} 处匹配项，当前第 ${result.current} 处`, 'success', 1500);

                    }
                }
            }

            // 执行替换
            function performReplace() {
                if (!tableEditor) return;
                
                const searchInput = document.getElementById('searchInput');
                const replaceInput = document.getElementById('replaceInput');
                const searchTerm = searchInput.value.trim();
                const replaceTerm = replaceInput.value;
                
                if (!searchTerm) {
                    showStatus('请输入要查找的内容', 'warning', 2000);
                    return;
                }
                
                const result = tableEditor.replaceText(searchTerm, replaceTerm, false);
                if (result) {
                    if (result > 0) {
                        showStatus('已替换', 'success', 1500);
                    } else {
                        showStatus('无匹配项', 'error', 2000);
                    }
                }
            }

            // 执行全部替换
            function performReplaceAll() {
                if (!tableEditor) return;
                
                const searchInput = document.getElementById('searchInput');
                const replaceInput = document.getElementById('replaceInput');
                const searchTerm = searchInput.value.trim();
                const replaceTerm = replaceInput.value;
                
                if (!searchTerm) {
                    showStatus('请输入要查找的内容', 'warning', 2000);
                    return;
                }
                
                const result = tableEditor.replaceText(searchTerm, replaceTerm, true);
                if (result) {
                    if (result > 0) {
                        showStatus(`已替换 ${result} 处`, 'success', 2000);
                    } else {
                        showStatus('无匹配项', 'error', 2000);
                    }
                }
            }

            // 关闭搜索栏
            function closeSearchBar() {
                const searchBar = document.getElementById('searchBar');
                if (searchBar) {
                    searchBar.style.display = 'none';
                }
                if (tableEditor) {
                    tableEditor.clearSearchHighlights();
                }
            }

            // 初始化表格编辑器
            let tableEditor;
            document.addEventListener('DOMContentLoaded', () => {
                tableEditor = new OfficeTableEditor('scheduleTable');
                
                // 设置菜单事件
                setupMenuEvents();
                
                // 初始化撤销/重做按钮状态
                updateUndoRedoButtons();
                
                // 为搜索输入框添加事件监听
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('keydown', handleSearchKeydown);
                }
                
                // 添加全局键盘快捷键支持
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Z 撤销
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        if (tableEditor) {
                            tableEditor.undoAction();
                        }
                    }
                    
                    // Ctrl+Shift+Z 或 Ctrl+Y 重做
                    if ((e.ctrlKey && e.shiftKey && e.key === 'Z') || (e.ctrlKey && e.key === 'y')) {
                        e.preventDefault();
                        if (tableEditor) {
                            tableEditor.redoAction();
                        }
                    }

                    // Ctrl+F 打开搜索栏
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        toggleSearchBar();
                    }

                    // Esc 关闭搜索栏
                    if (e.key === 'Escape') {
                        closeSearchBar();
                    }
                });

                // 为搜索输入框添加回车键事件
                document.addEventListener('keydown', (e) => {
                    if (e.target.id === 'searchInput') {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            performSearch('down');
                        } else if (e.key === 'Enter' && e.shiftKey) {
                            e.preventDefault();
                            performSearch('up');
                        }
                    }
                });
            });
            
            // 更新撤销/重做按钮状态
            function updateUndoRedoButtons() {
                const undoBtn = document.querySelector('button[onclick="undoAction()"]');
                const redoBtn = document.querySelector('button[onclick="redoAction()"]');
                
                if (undoBtn && redoBtn && tableEditor) {
                    const status = tableEditor.getUndoRedoStatus();
                    
                    // 更新撤销按钮
                    undoBtn.disabled = !status.canUndo;
                    undoBtn.title = status.canUndo ? 
                        `撤销 (${status.undoCount}/${status.maxHistory}) Ctrl+Z` : 
                        '无操作可撤销';
                    
                    // 更新重做按钮
                    redoBtn.disabled = !status.canRedo;
                    redoBtn.title = status.canRedo ? 
                        `重做 (${status.redoCount}/${status.maxHistory}) Ctrl+Shift+Z` : 
                        '无操作可重做';
                    
                    // 添加视觉反馈
                    undoBtn.style.opacity = status.canUndo ? '1' : '0.5';
                    redoBtn.style.opacity = status.canRedo ? '1' : '0.5';
                }
            }
            
            // 设置菜单事件处理
            function setupMenuEvents() {
                // 只为有子菜单的contextMenu设置事件
                const contextMenu = document.getElementById('contextMenu');
                if (contextMenu) {
                    // 使用事件委托来处理子菜单点击
                    contextMenu.addEventListener('click', function(e) {
                        const item = e.target.closest('.context-menu-item');
                        if (!item) return;
                        
                        const submenu = item.querySelector('.submenu');
                        if (submenu) {
                            // 确保点击的是有子菜单的项
                            e.stopPropagation();
                            e.preventDefault();
                            
                            // 切换活动状态
                            const isActive = item.classList.contains('active');
                            
                            // 关闭同一菜单中的其他子菜单
                            contextMenu.querySelectorAll('.context-menu-item').forEach(mi => {
                                mi.classList.remove('active');
                            });
                            
                            // 如果之前不是活动状态，则激活
                            if (!isActive) {
                                item.classList.add('active');
                            }
                        }
                    });
                    
                    // 阻止子菜单项的点击事件冒泡到父菜单
                    contextMenu.addEventListener('click', function(e) {
                        const submenuItem = e.target.closest('.submenu .context-menu-item');
                        if (submenuItem) {
                            e.stopPropagation();
                        }
                    });
                }
                
                // 点击外部关闭所有子菜单和菜单
                document.addEventListener('click', function(e) {
                    const isClickInsideMenu = e.target.closest('.context-menu') || e.target.closest('.long-press-menu');
                    if (!isClickInsideMenu) {
                        document.querySelectorAll('.context-menu-item.active').forEach(item => {
                            item.classList.remove('active');
                        });
                        
                        // 关闭所有菜单
                        const contextMenu = document.getElementById('contextMenu');
                        const longPressMenu = document.getElementById('longPressMenu');
                        if (contextMenu) {
                            contextMenu.style.display = 'none';
                            contextMenu.classList.remove('show');
                        }
                        if (longPressMenu) {
                            longPressMenu.style.display = 'none';
                            longPressMenu.classList.remove('show');
                        }
                    }
                });
                
                // ESC键关闭菜单
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const contextMenu = document.getElementById('contextMenu');
                        const longPressMenu = document.getElementById('longPressMenu');
                        if (contextMenu) {
                            contextMenu.style.display = 'none';
                            contextMenu.classList.remove('show');
                        }
                        if (longPressMenu) {
                            longPressMenu.style.display = 'none';
                            longPressMenu.classList.remove('show');
                        }
                    }
                });

                // 子菜单悬停事件 - 修复子菜单展开问题
                document.querySelectorAll('.context-menu-item.has-submenu').forEach(item => {
                    let hoverTimeout;
                    
                    item.addEventListener('mouseenter', function() {
                        clearTimeout(hoverTimeout);
                        
                        // 关闭其他子菜单
                        document.querySelectorAll('.context-menu-item.active').forEach(activeItem => {
                            if (activeItem !== this) {
                                activeItem.classList.remove('active');
                            }
                        });
                        
                        // 激活当前子菜单
                        this.classList.add('active');
                        
                        // 确保子菜单显示
                        const submenu = this.querySelector('.submenu');
                        if (submenu) {
                            submenu.style.display = 'block';
                        }
                    });
                    
                    item.addEventListener('mouseleave', function(e) {
                        const self = this;
                        hoverTimeout = setTimeout(() => {
                            // 检查鼠标是否在子菜单内
                            const submenu = self.querySelector('.submenu');
                            if (submenu) {
                                const rect = submenu.getBoundingClientRect();
                                const isInSubmenu = e.clientX >= rect.left && e.clientX <= rect.right && 
                                                  e.clientY >= rect.top && e.clientY <= rect.bottom;
                                
                                if (!isInSubmenu) {
                                    self.classList.remove('active');
                                    submenu.style.display = 'none';
                                }
                            }
                        }, 100);
                    });
                    
                    // 子菜单内的鼠标事件
                    const submenu = item.querySelector('.submenu');
                    if (submenu) {
                        submenu.addEventListener('mouseenter', function() {
                            clearTimeout(hoverTimeout);
                            item.classList.add('active');
                        });
                        
                        submenu.addEventListener('mouseleave', function() {
                            hoverTimeout = setTimeout(() => {
                                item.classList.remove('active');
                                this.style.display = 'none';
                            }, 100);
                        });
                    }
                });
                
                // 阻止右键菜单的默认行为
                document.addEventListener('contextmenu', function(e) {
                    if (e.target.closest('.context-menu') || e.target.closest('.long-press-menu')) {
                        e.preventDefault();
                    }
                });
            }

        // 工具栏按钮函数
        function addRow() { tableEditor.addRow(); }
        function addColumn() { tableEditor.addColumn(); }
        function deleteSelected() { tableEditor.deleteSelected(); }
        function copyCells() { tableEditor.copyCells(); }
        function pasteCells() { tableEditor.pasteCells(); }
        function mergeCells() { tableEditor.mergeCells(); }
        function splitCell() { tableEditor.splitCell(); }
        function clearCells() { tableEditor.clearCells(); }
        function undoAction() { tableEditor.undoAction(); }
        function redoAction() { tableEditor.redoAction(); }
        function deleteRow() { tableEditor.deleteRow(); }
        function deleteColumn() { tableEditor.deleteColumn(); }
        function fillSeries() { tableEditor.fillSeries(); }
        function findAndReplace() { tableEditor.findAndReplace(); }
        function autoFitColumns() { tableEditor.autoFitColumns(); }
        function exportData() { tableEditor.exportData(); }
        function importData() { tableEditor.importData(); }
        
        // 右键菜单函数
        function editCell() { 
            if (tableEditor.selectedCells && tableEditor.selectedCells.length > 0) {
                tableEditor.startEditing(tableEditor.selectedCells[0]); 
            }
        }
        function copyCell() { tableEditor.copyCells(); }
        function pasteCell() { tableEditor.pasteCells(); }
        function deleteCell() { tableEditor.deleteSelected(); }
        function clearCell() { tableEditor.clearCells(); }
        function mergeRight() { tableEditor.mergeCells(); }
        function mergeDown() { tableEditor.mergeCells(); }
        function selectRow() { tableEditor.selectRow(); }
        function selectColumn() { tableEditor.selectColumn(); }
        
        // 触屏长按菜单函数
        function editCellTouch() { 
            if (tableEditor.selectedCells && tableEditor.selectedCells.length > 0) {
                tableEditor.startEditing(tableEditor.selectedCells[0]); 
            }
        }
        function copyCellTouch() { tableEditor.copyCells(); }
        function pasteCellTouch() { tableEditor.pasteCells(); }
        function deleteCellTouch() { tableEditor.deleteSelected(); }
        function clearCellTouch() { tableEditor.clearCells(); }
    </script>
    <div id="status" class="status"></div>
</body>

</html>